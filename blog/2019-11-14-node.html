<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>å®æˆ˜ï¼ˆä¸‰ï¼‰ nodeä¸­é—´å±‚ | zxyçš„å‰ç«¯æ—¥å¿—</title>
    <meta name="description" content="å¤§å‰ç«¯ä¹‹è·¯å¼€å¯">
    <link rel="icon" href="/tom.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.4d237ac1.js" as="script"><link rel="preload" href="/assets/js/2.a060ff2c.js" as="script"><link rel="preload" href="/assets/js/51.5f15d9c7.js" as="script"><link rel="prefetch" href="/assets/js/10.9b1783bd.js"><link rel="prefetch" href="/assets/js/100.f2ba88c1.js"><link rel="prefetch" href="/assets/js/101.5e4ff941.js"><link rel="prefetch" href="/assets/js/102.3b9faf71.js"><link rel="prefetch" href="/assets/js/103.ef114a14.js"><link rel="prefetch" href="/assets/js/104.038f45d3.js"><link rel="prefetch" href="/assets/js/105.5b457551.js"><link rel="prefetch" href="/assets/js/106.c1138d30.js"><link rel="prefetch" href="/assets/js/107.52f38a92.js"><link rel="prefetch" href="/assets/js/108.a794593b.js"><link rel="prefetch" href="/assets/js/109.18b69319.js"><link rel="prefetch" href="/assets/js/11.9c1e82ab.js"><link rel="prefetch" href="/assets/js/110.2261fb1b.js"><link rel="prefetch" href="/assets/js/111.00ccfb14.js"><link rel="prefetch" href="/assets/js/112.a9104a88.js"><link rel="prefetch" href="/assets/js/113.9f3a8f8a.js"><link rel="prefetch" href="/assets/js/114.206ecfeb.js"><link rel="prefetch" href="/assets/js/115.5745e2df.js"><link rel="prefetch" href="/assets/js/116.c1f7447b.js"><link rel="prefetch" href="/assets/js/117.9e065728.js"><link rel="prefetch" href="/assets/js/118.0f2d3691.js"><link rel="prefetch" href="/assets/js/119.6bea2203.js"><link rel="prefetch" href="/assets/js/12.67149a6a.js"><link rel="prefetch" href="/assets/js/120.32450f30.js"><link rel="prefetch" href="/assets/js/121.fee9f710.js"><link rel="prefetch" href="/assets/js/122.def18904.js"><link rel="prefetch" href="/assets/js/123.25039dca.js"><link rel="prefetch" href="/assets/js/124.c4050122.js"><link rel="prefetch" href="/assets/js/125.46b40dfe.js"><link rel="prefetch" href="/assets/js/126.51a1a5d8.js"><link rel="prefetch" href="/assets/js/127.7867f500.js"><link rel="prefetch" href="/assets/js/128.49de406e.js"><link rel="prefetch" href="/assets/js/129.cdf49571.js"><link rel="prefetch" href="/assets/js/13.fb79cecf.js"><link rel="prefetch" href="/assets/js/130.8b3710bf.js"><link rel="prefetch" href="/assets/js/131.36dfdd90.js"><link rel="prefetch" href="/assets/js/132.e44f7288.js"><link rel="prefetch" href="/assets/js/133.ec885b28.js"><link rel="prefetch" href="/assets/js/134.f1316579.js"><link rel="prefetch" href="/assets/js/135.ecf5779f.js"><link rel="prefetch" href="/assets/js/136.996ceb08.js"><link rel="prefetch" href="/assets/js/137.0b240ef8.js"><link rel="prefetch" href="/assets/js/138.de8c92b0.js"><link rel="prefetch" href="/assets/js/139.aa2176ad.js"><link rel="prefetch" href="/assets/js/14.7f7c1b73.js"><link rel="prefetch" href="/assets/js/140.5e8ac77c.js"><link rel="prefetch" href="/assets/js/141.abbc86d6.js"><link rel="prefetch" href="/assets/js/142.9174e4b3.js"><link rel="prefetch" href="/assets/js/143.22fd8bba.js"><link rel="prefetch" href="/assets/js/144.aed38b7d.js"><link rel="prefetch" href="/assets/js/145.a6813681.js"><link rel="prefetch" href="/assets/js/146.41a80028.js"><link rel="prefetch" href="/assets/js/147.ba1a7770.js"><link rel="prefetch" href="/assets/js/148.877bea00.js"><link rel="prefetch" href="/assets/js/149.27096d07.js"><link rel="prefetch" href="/assets/js/15.fbb3ce6c.js"><link rel="prefetch" href="/assets/js/150.4eb384a9.js"><link rel="prefetch" href="/assets/js/151.528f4deb.js"><link rel="prefetch" href="/assets/js/152.192e9a1f.js"><link rel="prefetch" href="/assets/js/153.a3b71eb6.js"><link rel="prefetch" href="/assets/js/154.df79b8cb.js"><link rel="prefetch" href="/assets/js/155.aec97f81.js"><link rel="prefetch" href="/assets/js/16.03657715.js"><link rel="prefetch" href="/assets/js/17.20cbf2da.js"><link rel="prefetch" href="/assets/js/18.12a5dc5c.js"><link rel="prefetch" href="/assets/js/19.726a67f7.js"><link rel="prefetch" href="/assets/js/20.836a5d40.js"><link rel="prefetch" href="/assets/js/21.c951da6e.js"><link rel="prefetch" href="/assets/js/22.87c90120.js"><link rel="prefetch" href="/assets/js/23.99c7dbfb.js"><link rel="prefetch" href="/assets/js/24.d8c6d636.js"><link rel="prefetch" href="/assets/js/25.bb1086c1.js"><link rel="prefetch" href="/assets/js/26.31634d99.js"><link rel="prefetch" href="/assets/js/27.2fb85e0f.js"><link rel="prefetch" href="/assets/js/28.696d685c.js"><link rel="prefetch" href="/assets/js/29.488210dd.js"><link rel="prefetch" href="/assets/js/3.78e42548.js"><link rel="prefetch" href="/assets/js/30.2ba4ba04.js"><link rel="prefetch" href="/assets/js/31.d141acc1.js"><link rel="prefetch" href="/assets/js/32.086dce6f.js"><link rel="prefetch" href="/assets/js/33.ed1968ff.js"><link rel="prefetch" href="/assets/js/34.77827aa7.js"><link rel="prefetch" href="/assets/js/35.d5b914d6.js"><link rel="prefetch" href="/assets/js/36.f9397b07.js"><link rel="prefetch" href="/assets/js/37.64beee5f.js"><link rel="prefetch" href="/assets/js/38.67130674.js"><link rel="prefetch" href="/assets/js/39.de9f3702.js"><link rel="prefetch" href="/assets/js/4.5197eef5.js"><link rel="prefetch" href="/assets/js/40.f23dcf4c.js"><link rel="prefetch" href="/assets/js/41.b6418c92.js"><link rel="prefetch" href="/assets/js/42.75dabff5.js"><link rel="prefetch" href="/assets/js/43.7e1d7e20.js"><link rel="prefetch" href="/assets/js/44.53712706.js"><link rel="prefetch" href="/assets/js/45.dafdeeff.js"><link rel="prefetch" href="/assets/js/46.66f32e9c.js"><link rel="prefetch" href="/assets/js/47.23958449.js"><link rel="prefetch" href="/assets/js/48.f4ec7b60.js"><link rel="prefetch" href="/assets/js/49.518f1bec.js"><link rel="prefetch" href="/assets/js/5.b26139fb.js"><link rel="prefetch" href="/assets/js/50.c8e8fb43.js"><link rel="prefetch" href="/assets/js/52.4db4cdfb.js"><link rel="prefetch" href="/assets/js/53.6af7b618.js"><link rel="prefetch" href="/assets/js/54.fec88fbe.js"><link rel="prefetch" href="/assets/js/55.a7e02100.js"><link rel="prefetch" href="/assets/js/56.67d70446.js"><link rel="prefetch" href="/assets/js/57.4866ef69.js"><link rel="prefetch" href="/assets/js/58.e6488e01.js"><link rel="prefetch" href="/assets/js/59.2467dc1e.js"><link rel="prefetch" href="/assets/js/6.b88b0bec.js"><link rel="prefetch" href="/assets/js/60.a4188798.js"><link rel="prefetch" href="/assets/js/61.b275a457.js"><link rel="prefetch" href="/assets/js/62.d6b63240.js"><link rel="prefetch" href="/assets/js/63.681f3d8b.js"><link rel="prefetch" href="/assets/js/64.9eeded5a.js"><link rel="prefetch" href="/assets/js/65.19721dd4.js"><link rel="prefetch" href="/assets/js/66.038614c3.js"><link rel="prefetch" href="/assets/js/67.d802f033.js"><link rel="prefetch" href="/assets/js/68.ce021a23.js"><link rel="prefetch" href="/assets/js/69.7ceca11e.js"><link rel="prefetch" href="/assets/js/7.0d983d99.js"><link rel="prefetch" href="/assets/js/70.f997d037.js"><link rel="prefetch" href="/assets/js/71.c1557031.js"><link rel="prefetch" href="/assets/js/72.2d9f5c4e.js"><link rel="prefetch" href="/assets/js/73.11ad7e38.js"><link rel="prefetch" href="/assets/js/74.eab8f5c6.js"><link rel="prefetch" href="/assets/js/75.e9fb6786.js"><link rel="prefetch" href="/assets/js/76.abdc4f64.js"><link rel="prefetch" href="/assets/js/77.dc44de72.js"><link rel="prefetch" href="/assets/js/78.ebf803d8.js"><link rel="prefetch" href="/assets/js/79.3228bce2.js"><link rel="prefetch" href="/assets/js/8.8a23a928.js"><link rel="prefetch" href="/assets/js/80.8c3fdc1e.js"><link rel="prefetch" href="/assets/js/81.f1472a60.js"><link rel="prefetch" href="/assets/js/82.95875586.js"><link rel="prefetch" href="/assets/js/83.6bfbbc19.js"><link rel="prefetch" href="/assets/js/84.91ade6f8.js"><link rel="prefetch" href="/assets/js/85.b5fdbf72.js"><link rel="prefetch" href="/assets/js/86.9d1404c5.js"><link rel="prefetch" href="/assets/js/87.0567def1.js"><link rel="prefetch" href="/assets/js/88.0763a6b6.js"><link rel="prefetch" href="/assets/js/89.b76800ed.js"><link rel="prefetch" href="/assets/js/9.11df2484.js"><link rel="prefetch" href="/assets/js/90.e9371a29.js"><link rel="prefetch" href="/assets/js/91.3abf758b.js"><link rel="prefetch" href="/assets/js/92.49121cc0.js"><link rel="prefetch" href="/assets/js/93.e7b2f6cc.js"><link rel="prefetch" href="/assets/js/94.c3307a0b.js"><link rel="prefetch" href="/assets/js/95.90dfe36e.js"><link rel="prefetch" href="/assets/js/96.4df4988a.js"><link rel="prefetch" href="/assets/js/97.60b1c42f.js"><link rel="prefetch" href="/assets/js/98.6394b8d8.js"><link rel="prefetch" href="/assets/js/99.98be11a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">zxyçš„å‰ç«¯æ—¥å¿—</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">åšå®¢</a></div><div class="nav-item"><a href="/interview/" class="nav-link">é¢è¯•é¢˜</a></div><div class="nav-item"><a href="/book/" class="nav-link">é˜…è¯»</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">åšå®¢</a></div><div class="nav-item"><a href="/interview/" class="nav-link">é¢è¯•é¢˜</a></div><div class="nav-item"><a href="/book/" class="nav-link">é˜…è¯»</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>PHP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-05-28-php.html" class="sidebar-link">PHPå­¦ä¹ (ä¸€) åŸºç¡€è¯­æ³•</a></li><li><a href="/blog/2019-06-05-php&amp;mysql.html" class="sidebar-link">PHPå­¦ä¹ (äºŒ) phpä¸mysql</a></li><li><a href="/blog/2019-06-05-php_OOP_introduction.html" class="sidebar-link">PHPå­¦ä¹ (ä¸‰) phpé¢å‘å¯¹è±¡ä»‹ç»</a></li><li><a href="/blog/2019-06-05-PHP_construct.html" class="sidebar-link">PHPå­¦ä¹ (å››) æ„é€ æ–¹æ³•å’Œææ„æ–¹æ³•</a></li><li><a href="/blog/2019-06-10-OOP_fengzhuang.html" class="sidebar-link">PHPå­¦ä¹ (äº”) PHPé¢å‘å¯¹è±¡ä¹‹å°è£…æ€§</a></li><li><a href="/blog/2019-06-10-OOP_jicheng_duotai.html" class="sidebar-link">PHPå­¦ä¹ (å…­) PHPé¢å‘å¯¹è±¡ä¹‹ç»§æ‰¿ä¸å¤šæ€</a></li><li><a href="/blog/2019-06-10-OOP_interface_abstract.html" class="sidebar-link">PHPå­¦ä¹ (ä¸ƒ) PHPæŠ½è±¡ç±»ä¸æ¥å£</a></li><li><a href="/blog/2019-06-11-OPP_error.html" class="sidebar-link">PHPå­¦ä¹ (å…«) PHPå¼‚å¸¸å¤„ç†</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-06-25-node.html" class="sidebar-link">Node.jså­¦ä¹ (åŸºç¡€)</a></li><li><a href="/blog/2019-06-26-express1.html" class="sidebar-link">expresså­¦ä¹ (ä¸€) expressä»‹ç»</a></li><li><a href="/blog/2019-06-27-express-middleware.html" class="sidebar-link">expresså­¦ä¹ (äºŒ) ä¸­é—´ä»¶</a></li><li><a href="/blog/2019-06-27-express-router.html" class="sidebar-link">expresså­¦ä¹ (ä¸‰) è·¯ç”±</a></li><li><a href="/blog/2019-06-27-express-error.html" class="sidebar-link">expresså­¦ä¹ (å››) é”™è¯¯å¤„ç†</a></li><li><a href="/blog/2019-08-19-node.html" class="sidebar-link">å¤§è§„æ¨¡NodeJSé¡¹ç›®æ¶æ„ä¸ä¼˜åŒ–</a></li><li><a href="/blog/2019-08-20-node-pachong.html" class="sidebar-link">çˆ¬è™«</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å·¥ç¨‹åŒ–</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-06-27-qa.html" class="sidebar-link">Javascriptä¸QAå·¥ç¨‹å¸ˆ(ä¸€)</a></li><li><a href="/blog/2019-08-04-QA.html" class="sidebar-link">Javascriptä¸QAå·¥ç¨‹å¸ˆ(äºŒ)</a></li><li><a href="/blog/2019-07-05-webpack1.html" class="sidebar-link">webpack4(ä¸€) webpackçš„æ ¸å¿ƒæ¦‚å¿µ</a></li><li><a href="/blog/2019-07-05-webpack2.html" class="sidebar-link">webpack4(äºŒ) webpackçš„é«˜çº§æ¦‚å¿µ</a></li><li><a href="/blog/2019-07-09-webpack3.html" class="sidebar-link">webpack4(ä¸‰) webpackå®æˆ˜é…ç½®</a></li><li><a href="/blog/2019-07-10-webpack4.html" class="sidebar-link">webpack4(å››) webpackåº•å±‚åŸç†åŠè„šæ‰‹æ¶å·¥å…·åˆ†æ</a></li><li><a href="/blog/2019-08-28-gongchenghua1.html" class="sidebar-link">å‰ç«¯å·¥ç¨‹åŒ–Linuxé¢„å¤‡çŸ¥è¯†</a></li><li><a href="/blog/2019-08-29-jenkins.html" class="sidebar-link">å‰ç«¯å·¥ç¨‹åŒ–ä¹‹CI&amp;CD --jenkins</a></li><li><a href="/blog/2019-09-02-chixujicheng.html" class="sidebar-link">ä»0åˆ°å¤§è®ºå‰ç«¯æŒç»­é›†æˆ</a></li><li><a href="/blog/2019-09-02-mycli.html" class="sidebar-link">æ‰‹å†™ä¸€ä¸ªè‡ªå·±çš„cli</a></li><li><a href="/blog/2019-09-04-gulp.html" class="sidebar-link">æ„å»ºå·¥å…·</a></li><li><a href="/blog/2019-10-17-rongcuo.html" class="sidebar-link">å®¹é”™</a></li><li><a href="/blog/2019-11-14-docker.html" class="sidebar-link">å¾®æœåŠ¡å…¥é—¨ä¸Dockerå®æˆ˜</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>æ€§èƒ½ä¼˜åŒ–</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-09-11-xingnengyouhua.html" class="sidebar-link">å‰ç«¯æ€§èƒ½ä¼˜åŒ– æœåŠ¡å™¨</a></li><li><a href="/blog/2019-09-12-yahujungui.html" class="sidebar-link">é›…è™å†›è§„</a></li><li><a href="/blog/2019-09-16-xingnengyouhua.html" class="sidebar-link">å‰ç«¯æ¶æ„ä¸æ€§èƒ½ä¼˜åŒ–é‚£äº›äº‹å„¿</a></li><li><a href="/blog/2019-12-12-webpack.html" class="sidebar-link">webpack æ€§èƒ½ä¼˜åŒ–</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-10-09-css-workflow.html" class="sidebar-link">ç°ä»£åŒ–cssæ–¹æ³•è®º CSS WorkFlow</a></li><li><a href="/blog/2019-10-10-css-hodini.html" class="sidebar-link">CSSé­”æœ¯å¸ˆHoudini</a></li><li><a href="/blog/2019-11-18-flex-css.html" class="sidebar-link">flexå¸ƒå±€</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>jsåŸºç¡€</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-12-02-es6-Map.html" class="sidebar-link">Set å’Œ Map</a></li><li><a href="/blog/2019-12-10-jicheng.html" class="sidebar-link">ç»§æ‰¿</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>ç¼–ç¨‹åŸºç¡€</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-07-31-fp-.html" class="sidebar-link">å‡½æ•°å¼ç¼–ç¨‹</a></li><li><a href="/blog/2019-10-20-sixiang.html" class="sidebar-link">é¢å‘åˆ‡é¢çš„ç¼–ç¨‹æ€æƒ³</a></li><li><a href="/blog/2020-01-05-shejimoshi.html" class="sidebar-link">è®¾è®¡æ¨¡å¼</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-05-27-Linux-instructions.html" class="sidebar-link">Linuxå¸¸ç”¨æŒ‡ä»¤</a></li><li><a href="/blog/2019-07-31-linux.html" class="sidebar-link">Linuxé¢„è¯»</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>æµè§ˆå™¨ç½‘ç»œåè®®</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-08-14-http1.html" class="sidebar-link">HTTPåè®®é‚£äº›äº‹(ä¸€)</a></li><li><a href="/blog/2019-08-15-http2.html" class="sidebar-link">HTTPåè®®é‚£äº›äº‹(äºŒ)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>æ•°æ®ç»“æ„ä¸ç®—æ³•</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-12-06-data.html" class="sidebar-link">åŸºç¡€æ•°æ®ç»“æ„</a></li><li><a href="/blog/2019-12-04-sort.html" class="sidebar-link">æ’åºç®—æ³•</a></li><li><a href="/blog/2019-12-10-suanfa.html" class="sidebar-link">ç®—æ³•æ¦‚è®º</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>å›¾å½¢å­¦</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-12-15-canvas.html" class="sidebar-link">canvas 2d å…¥é—¨</a></li><li><a href="/blog/2019-12-15-3då…¥é—¨.html" class="sidebar-link">3Då›¾å½¢å­¦å…¥é—¨</a></li><li><a href="/blog/2019-12-15-webgl1.html" class="sidebar-link">WebGL æ¦‚è¿°</a></li><li><a href="/blog/2019-12-15-webglå…¥é—¨.html" class="sidebar-link">WebGL å…¥é—¨</a></li><li><a href="/blog/2020-09-16-three1.html" class="sidebar-link">threejs å…¥é—¨ï¼ˆä¸€ï¼‰</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>electron</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2020-01-31-electron.html" class="sidebar-link">electronå­¦ä¹ (ä¸€) åŸºç¡€æ¦‚å¿µ</a></li><li><a href="/blog/2020-02-01-electron.html" class="sidebar-link">electronå­¦ä¹ (äºŒ) ç¯å¢ƒé…ç½®</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>tensorflow</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2020-02-04-tensorflow.html" class="sidebar-link">ç¥ç»ç½‘ç»œ</a></li><li><a href="/blog/2020-02-05-tensorflow.html" class="sidebar-link">çº¿æ€§å›å½’ä»»åŠ¡</a></li><li><a href="/blog/2020-02-05-tensorflow2.html" class="sidebar-link">å½’ä¸€åŒ–ä»»åŠ¡</a></li><li><a href="/blog/2020-02-06-tensorflow.html" class="sidebar-link">é€»è¾‘å›å½’ä»»åŠ¡</a></li><li><a href="/blog/2020-02-06-tensorflow2.html" class="sidebar-link">å¤šå±‚ç¥ç»ç½‘ç»œä»»åŠ¡</a></li><li><a href="/blog/2020-02-07-tensorflow.html" class="sidebar-link">å¤šåˆ†ç±»ä»»åŠ¡</a></li><li><a href="/blog/2020-02-07-tensorflow2.html" class="sidebar-link">æ¬ æ‹Ÿåˆä¸è¿‡æ‹Ÿåˆä»»åŠ¡</a></li><li><a href="/blog/2020-02-08-tensorflow.html" class="sidebar-link">ä½¿ç”¨å·ç§¯ç¥ç»ç½‘ç»œè¯†åˆ«æ‰‹å†™æ•°å­—ä»»åŠ¡</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>æºç è§£è¯»</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-11-13-yuanmadu.html" class="sidebar-link">å¦‚ä½•é˜…è¯»æºç </a></li><li><a href="/blog/reactæºç 1.html" class="sidebar-link">React æºç è§£è¯»ï¼ˆä¸€ï¼‰JSX</a></li><li><a href="/blog/reactæºç 2.html" class="sidebar-link">React æºç è§£è¯»ï¼ˆäºŒï¼‰ Fiber Root</a></li><li><a href="/blog/reactæºç 3.html" class="sidebar-link">React æºç è§£è¯»ï¼ˆä¸‰ï¼‰ requestWork</a></li><li><a href="/blog/reactæºç 4.html" class="sidebar-link">React æºç è§£è¯»ï¼ˆå››ï¼‰ setState</a></li><li><a href="/blog/reactæºç 5.html" class="sidebar-link">React æºç è§£è¯»ï¼ˆäº”ï¼‰ hooks</a></li><li><a href="/blog/reactæºç 6.html" class="sidebar-link">React æºç è§£è¯»ï¼ˆå…­ï¼‰ hooks åŸç†ï¼ˆuseStateï¼‰</a></li><li><a href="/blog/2019-12-13-diff.html" class="sidebar-link">æ‰‹å†™ Dom dff</a></li><li><a href="/blog/2019-11-27-webpack.html" class="sidebar-link">webpackæºç ï¼ˆä¸€ï¼‰</a></li><li><a href="/blog/2019-12-01-webpack.html" class="sidebar-link">webpackæºç ï¼ˆäºŒï¼‰</a></li><li><a href="/blog/2019-12-04-koa.html" class="sidebar-link">æ‰‹å†™ Koa</a></li><li><a href="/blog/2019-12-24-create-react-app.html" class="sidebar-link">create-react-app æºç åˆ†æ</a></li><li><a href="/blog/2020-06-08-lottie.html" class="sidebar-link">lottieåŸç†æ¢ç´¢</a></li><li><a href="/blog/2020-06-30-vueæºç .html" class="sidebar-link">Vue2æºç è§£æ</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>å®æˆ˜</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/webpack-0-1.html" class="sidebar-link">å®æˆ˜ï¼ˆä¸€ï¼‰ webpack ç¯å¢ƒæ­å»º</a></li><li><a href="/blog/2019-11-18-react.html" class="sidebar-link">å®æˆ˜ï¼ˆäºŒï¼‰react-hooksã€è·¯ç”±</a></li><li><a href="/blog/2019-11-14-node.html" class="active sidebar-link">å®æˆ˜ï¼ˆä¸‰ï¼‰ nodeä¸­é—´å±‚</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#åŸºç¡€ç¯å¢ƒ" class="sidebar-link">åŸºç¡€ç¯å¢ƒ</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#åˆ›å»ºiocå®¹å™¨" class="sidebar-link">åˆ›å»ºIOCå®¹å™¨</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#interface" class="sidebar-link">interface</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#service" class="sidebar-link">service</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#controller" class="sidebar-link">controller</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#æ¸²æŸ“é¡µé¢" class="sidebar-link">æ¸²æŸ“é¡µé¢</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#å®¹é”™å¤„ç†å’Œæ—¥å¿—" class="sidebar-link">å®¹é”™å¤„ç†å’Œæ—¥å¿—</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#æŠ½ç¦»ä¸­é—´ä»¶" class="sidebar-link">æŠ½ç¦»ä¸­é—´ä»¶</a></li></ul></li><li><a href="/blog/2019-11-22-gulp.html" class="sidebar-link">å®æˆ˜ï¼ˆå››ï¼‰ gulp æµæ¸…æ´—</a></li><li><a href="/blog/2019-08-25-bff-shizhan.html" class="sidebar-link">BFFå®æˆ˜</a></li><li><a href="/blog/2019-09-07-webpack-shizhan.html" class="sidebar-link">å·¥ç¨‹åŒ–å®æˆ˜</a></li><li><a href="/blog/2019-10-10-xingnengyouhua-shizhan.html" class="sidebar-link">æ€§èƒ½ä¼˜åŒ–å®æˆ˜</a></li><li><a href="/blog/2019-10-14-xingnengyouhua-shizhan2.html" class="sidebar-link">æ€§èƒ½ä¼˜åŒ–å®æˆ˜(äºŒ)</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="å®æˆ˜ï¼ˆä¸‰ï¼‰-nodeä¸­é—´å±‚"><a href="#å®æˆ˜ï¼ˆä¸‰ï¼‰-nodeä¸­é—´å±‚" class="header-anchor">#</a> å®æˆ˜ï¼ˆä¸‰ï¼‰ nodeä¸­é—´å±‚</h1> <h2 id="åŸºç¡€ç¯å¢ƒ"><a href="#åŸºç¡€ç¯å¢ƒ" class="header-anchor">#</a> åŸºç¡€ç¯å¢ƒ</h2> <p>è¿è¡Œnodeç«¯çš„tséœ€è¦å…¨å±€å®‰è£… ts-nodeï¼Œå¯¹åº”ç€è‡ªåŠ¨åˆ·æ–°çš„æ˜¯ ts-node-dev</p> <p>å®‰è£… koa</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>å®‰è£… @types/koa</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>nodeç«¯æˆ‘ä»¬é‡‡ç”¨ MVC çš„æ¨¡å¼è¿›è¡Œå»ºç«‹</p> <p>åœ¨srcä¸‹åˆ›å»ºserveræ–‡ä»¶å¤¹ï¼Œå…·ä½“ç›®å½•ç»“æ„å¦‚å›¾</p> <p><img src="20191120-node1.png" alt="ç›®å½•"></p> <p>å…ˆå†™ä¸€ä¸ªç®€å•çš„å…¥å£æ–‡ä»¶ app.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;hello koa&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;æ•°æ®ç›‘æ§ç³»ç»ŸğŸºï¼Œserver is running on port8888&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>åœ¨tsä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨import</li> <li>ç”¨koaå¯åŠ¨ä¸€ä¸ªæœ€åŸºæœ¬çš„æœåŠ¡ï¼Œå¯ä»¥åœ¨ localhost:8888 ä¸‹çœ‹åˆ° <code>hello koa</code></li></ul> <p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥æŠŠç«¯å£å·æå‡ºæ¥ï¼Œæ”¾åœ¨configä¸­</p> <p>config/index.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> extend <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">configIn</span> <span class="token punctuation">{</span>
  viewDir<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  staticDir<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  env<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  port<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> config<span class="token punctuation">:</span> configIn <span class="token operator">=</span> <span class="token punctuation">{</span>
  viewDir<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;..&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  staticDir<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;..&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;assets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  env<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> <span class="token number">8081</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> config<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>è¿™é‡Œæˆ‘ä»¬å®‰è£… <code>lodash</code> åº“åšä¸ºå·¥å…·åº“ï¼Œä½¿ç”¨<code>extend</code>æ–¹æ³•æ¥åˆå¹¶<code>port</code></li> <li>åˆ†åˆ«è®¾ç½®é™æ€èµ„æºå’Œé¡µé¢çš„è·¯å¾„</li> <li>æŒ‰ç¯å¢ƒå˜é‡ä¸åŒåˆ†åˆ«è®¾ç½®å¼€å‘ç¯å¢ƒå’Œä¸Šçº¿ç¯å¢ƒçš„ç«¯å£</li></ul> <p>è¿™æ ·æˆ‘ä»¬çš„app.tså°±å¯ä»¥æ”¹æˆä¸‹é¢è¿™æ ·</p> <p>app.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ›å»ºæœåŠ¡å®ä¾‹</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;hello koa&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">æ•°æ®ç›‘æ§ç³»ç»ŸğŸºï¼Œserver is running on port</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>koaæ˜¯ä¸€ä¸ªéå¸¸ç²¾ç®€çš„æ¡†æ¶ï¼Œä¸åŒäºexpressï¼ŒkoaæŠŠæ‰€æœ‰çš„åŠŸèƒ½éƒ½æ‹¿äº†å‡ºå»ï¼Œé€šè¿‡æ’å…¥ä¸åŒçš„ä¸­é—´ä»¶æ¥å®ç°åŠŸèƒ½ã€‚</p> <p>å®‰è£… <code>koa-bodyparser</code> å’Œ <code>@types/koa-bodyparser</code> æ¥æ¥æ”¶å¹¶è§£æè¯·æ±‚</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa-bodyparser
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa-bodyparser --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>åœ¨ app.ts ä¸­å¼•å…¥</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> bodyParser <span class="token keyword">from</span> <span class="token string">&quot;koa-bodyparser&quot;</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>å®‰è£… <code>koa-static</code> å’Œ <code>@types/koa-static</code> ç”¨æ¥ç»‘å®šé™æ€èµ„æº</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa-static
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa-static --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>è¿™é‡Œç›´æ¥ä½¿ç”¨IOCçš„æ–¹å¼æ¥è¿›è¡Œè·¯ç”±ç®¡ç†ï¼Œå°±ä¸ä½¿ç”¨ koa-route äº†</p> <p>å®‰è£… <code>awilix</code> å’Œ <code>awilix-koa</code> ç”¨æ¥åšå®¹å™¨ç®¡ç†</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add awilix awilix-koa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="åˆ›å»ºiocå®¹å™¨"><a href="#åˆ›å»ºiocå®¹å™¨" class="header-anchor">#</a> åˆ›å»ºIOCå®¹å™¨</h2> <p>okkï¼Œæ¥ä¸‹æ¥å…ˆåˆ›å»ºå®¹å™¨å§</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createContainer<span class="token punctuation">,</span> Lifetime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;awilix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>loadControllers<span class="token punctuation">,</span> scopePerRequest<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'awilix-koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> historyApiFallback <span class="token keyword">from</span> <span class="token string">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ›å»ºå®¹å™¨</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ª new model</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">scopePerRequest</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// è£…è½½æ‰€æœ‰çš„service(models)ï¼Œå¹¶å°† servicesä»£ç æ³¨å…¥åˆ°controllers</span>
container<span class="token punctuation">.</span><span class="token function">loadModules</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./service/*.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./util/SafeRequest.ts'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    formatName<span class="token punctuation">:</span> <span class="token string">'camelCase'</span><span class="token punctuation">,</span>
    resolveOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      lifetime<span class="token punctuation">:</span> Lifetime<span class="token punctuation">.</span><span class="token constant">SCOPED</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token comment">//æ³¨å†Œæ‰€æœ‰è·¯ç”±</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">loadControllers</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../controller/*.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    cwd<span class="token punctuation">:</span> __dirname
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> whiteList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>é€šè¿‡ <code>createContainer</code> åˆ›å»ºå®¹å™¨</li> <li>ç”¨ <code>scopePerRequest</code> æŠŠå®¹å™¨å’Œè·¯ç”±æœ€ç»ˆåˆå¹¶åˆ°ä¸€èµ·ï¼Œæ¯æ¬¡è¯·æ±‚éƒ½å»å®¹å™¨é‡Œå»å–</li> <li><code>loadModules</code> æŠŠæ‰€æœ‰çš„ <code>service</code> æ³¨å…¥åˆ°å®¹å™¨ä¸­</li> <li><code>loadControllers</code> æ³¨å†Œæ‰€æœ‰è·¯ç”±</li> <li>historyApiFallback ç”¨äºè®©koa2æ”¯æŒSPAåº”ç”¨ç¨‹åºã€‚</li></ul> <h2 id="interface"><a href="#interface" class="header-anchor">#</a> interface</h2> <p>å…ˆåœ¨ <code>interface</code> ä¸‹å†™å‡ ä¸ªæ¥å£æ–‡ä»¶ï¼Œåˆ«ç®¡å¹²å•¥çš„ï¼Œå…ˆæ”¾ç€ â•®(â•¯â–½â•°)â•­</p> <p>interface/IApi.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IApi</span> <span class="token punctuation">{</span>
  <span class="token function">getInfo</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>interface/IIndex.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> User <span class="token keyword">from</span> <span class="token string">'../model/user'</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IIdex</span> <span class="token punctuation">{</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> User
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>model/user</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    email<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>interface/ISafeRequest.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ISafeRequest</span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>interface/ISocketHandler.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ISocketHandler</span> <span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="service"><a href="#service" class="header-anchor">#</a> service</h2> <p>æ¥ä¸‹æ¥å†™ä¸¤ä¸ª <code>service</code></p> <p>service/IndexService.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IIdex <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/IIndex'</span>
<span class="token keyword">import</span> User <span class="token keyword">from</span> <span class="token string">'../model/User'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">IndexService</span> <span class="token keyword">implements</span> <span class="token class-name">IIdex</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">private</span> userStorage<span class="token punctuation">:</span> User<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      email<span class="token punctuation">:</span> <span class="token string">&quot;yuanzhijia@yidengfe.com&quot;</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;zhijia&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      email<span class="token punctuation">:</span> <span class="token string">&quot;Copyright Â© 2016 yidengfe.com All Rights Reversed.äº¬ICPå¤‡16022242å·-1&quot;</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;laowang&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>

  <span class="token keyword">public</span> <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> User <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result<span class="token punctuation">:</span> User

    result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userStorage<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>æ³¨æ„åœ¨å†™ <code>service</code> æ—¶çš„å‘½åè¦ç”¨å¤§é©¼å³°ï¼Œåé¢åœ¨ <code>controller</code> ä¸­è¦å¯¹åº”å¥½ï¼Œä½¿ç”¨å°é©¼å³°</li> <li>åœ¨è¿™é‡Œå®šä¹‰ç”¨æˆ·ä¿¡æ¯</li></ul> <p>service/ApiService.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// import safeRequest from '../util/SafeRequest'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/IApi'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ApiService</span> <span class="token keyword">implements</span> <span class="token class-name">IApi</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> safeRequest <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>safeRequest <span class="token operator">=</span> safeRequest
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">getInfo</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>safeRequest<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>å‰é¢åœ¨æ³¨å…¥çš„æ—¶å€™ï¼Œå·²ç»å°† <code>SafeRequest</code> æ–¹æ³•æ³¨å…¥åˆ°å®¹å™¨ä¸­äº†ï¼Œåœ¨è¿™é‡Œç›´æ¥ç»“æ„å‡ºæ¥ï¼Œä½¿ç”¨ <code>getInfo</code> æ–¹æ³•è°ƒç”¨</li></ul> <p>SafeRequest.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fetch <span class="token keyword">from</span> <span class="token string">'node-fetch'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ISafeRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/ISafeRequest'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SafeRequest</span> <span class="token keyword">implements</span> <span class="token class-name">ISafeRequest</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
    url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
    callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">json</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="controller"><a href="#controller" class="header-anchor">#</a> controller</h2> <p>æ¥ä¸‹æ¥å°±æ˜¯é‡å¤´æˆ <code>controller</code></p> <p>å†™ä¸¤ä¸ª <code>controller</code></p> <p>controller/IndexController.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Router <span class="token keyword">from</span> <span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> route<span class="token punctuation">,</span> <span class="token constant">GET</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;awilix-koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> User <span class="token keyword">from</span> <span class="token string">&quot;../model/User&quot;</span><span class="token punctuation">;</span>

@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> indexService
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> indexService <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexService <span class="token operator">=</span> indexService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
  @<span class="token constant">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">:</span> Router<span class="token punctuation">.</span>IRouterContext<span class="token punctuation">,</span>
    <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result<span class="token punctuation">:</span> User <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> result<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>å¼•å…¥äº† koa-router è¦è®°å¾—å®‰è£…ä¸€ä¸‹ï¼Œä¸ºäº†ç»™ ctx æ·»åŠ ç±»å‹æ£€æµ‹</li> <li>åœ¨æ„é€ å‡½æ•°ä¸­ç»“æ„å‡º <code>indexService</code>ï¼Œè®°å¾—åå­—è¦è·Ÿ service æ–‡ä»¶åå¯¹ä¸Šï¼Œå¤§å°å†™æ³¨æ„</li> <li>ç„¶åè¦ç»‘å®šè·¯ç”±ï¼Œä» <code>awilix-koa</code> å¼•å…¥çš„ <code>route</code> å’Œ <code>GET</code> æ–¹æ³•ç›´æ¥é€šè¿‡è£…é¥°å™¨çš„æ–¹å¼å°†è·¯ç”±æ³¨å…¥è¿›å»</li> <li>åŒä¸€ä¸ªç±»æˆ–æ–¹æ³•ä¸Šé¢å¯ä»¥ç”¨å¤šä¸ªè£…é¥°å™¨ï¼Œ@route(&quot;/&quot;) å’Œ @GET() è¡¨ç¤ºåœ¨ '/' è·¯ç”±æ—¶é€šè¿‡ get è¯·æ±‚æ¥å£</li></ul> <p>controller/ApiController.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Router <span class="token keyword">from</span> <span class="token string">'koa-router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> route<span class="token punctuation">,</span> <span class="token constant">GET</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'awilix-koa'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/IApi'</span>

@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ApiController</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> apiService
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiService <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apiService <span class="token operator">=</span> apiService
  <span class="token punctuation">}</span>
  @<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">)</span>
  @<span class="token constant">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">:</span> Router<span class="token punctuation">.</span>IRouterContext<span class="token punctuation">,</span>
    <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result<span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apiService<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>å®šä¹‰å‡ ä¸ªæ•°æ®æ¥å£</li> <li>æ¥æ”¶å‰ç«¯çš„æ¥å£è¯·æ±‚ï¼Œç„¶åå»åç«¯åœ°å€è¯·æ±‚æ•°æ®å›æ¥ï¼Œå†è¿”å›ç»™å‰ç«¯</li></ul> <p>è‡³æ­¤ï¼Œä¸€ä¸ªåŸºæœ¬çš„å·²ç»æ­èµ·æ¥äº†ã€‚</p> <p>å¯åŠ¨æœåŠ¡ï¼Œå…ˆæ‰“å¼€ localhost:8081/api/testï¼Œå¯ä»¥çœ‹åˆ°æ‹¿åˆ°äº†è¯·æ±‚çš„æ•°æ®</p> <p><img src="20191121-node1.png" alt="api"></p> <h2 id="æ¸²æŸ“é¡µé¢"><a href="#æ¸²æŸ“é¡µé¢" class="header-anchor">#</a> æ¸²æŸ“é¡µé¢</h2> <p>é€šè¿‡ swig æ¨¡æ¿å¼•æ“è¿›è¡Œæ¸²æŸ“é¡µé¢ã€‚å½“ç„¶å®é™…ä¸Šæˆ‘ä»¬æ˜¯ç”¨reactè¿›è¡Œé¡µé¢çš„ç»˜åˆ¶ï¼Œè¿™é‡Œå…ˆé€šè¿‡åç«¯æ¸²æŸ“ä¸Šæ¥ï¼Œåé¢ä¼šåšssråŒæ„ã€‚</p> <p>å®‰è£… koa-swig koa-static co @types/co @types/koa-static</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa-swig koa-static
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa-static @types/co --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> render <span class="token keyword">from</span> <span class="token string">&quot;koa-swig&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> serve <span class="token keyword">from</span> <span class="token string">&quot;koa-static&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> co <span class="token keyword">from</span> <span class="token string">&quot;co&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//é…ç½®swig(å‰ç«¯æ¨¡æ¿)</span>
  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      root<span class="token punctuation">:</span> config<span class="token punctuation">.</span>viewDir<span class="token punctuation">,</span>
      autoescape<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      cache<span class="token punctuation">:</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">,</span>
      ext<span class="token punctuation">:</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span>
      writeBody<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//é…ç½®é™æ€æ–‡ä»¶ç›®å½•</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>åœ¨appä¸Šç»‘å®š <code>render</code> æ–¹æ³•</li> <li>root æŒ‡å®šæ ¹è·¯å¾„</li> <li>é€šè¿‡ serve é…ç½®é™æ€æ–‡ä»¶ç›®å½•</li></ul> <h2 id="å®¹é”™å¤„ç†å’Œæ—¥å¿—"><a href="#å®¹é”™å¤„ç†å’Œæ—¥å¿—" class="header-anchor">#</a> å®¹é”™å¤„ç†å’Œæ—¥å¿—</h2> <p>æ¥ä¸‹æ¥è¯¥æ·»åŠ æ—¥å¿—äº†å’Œåšä¸€äº›å®¹é”™å¤„ç†äº†ã€‚</p> <p>é¦–å…ˆå®‰è£… <code>log4js</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add log4js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>åœ¨ app ä¸ŠæŒ‚è½½ logger</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> configure<span class="token punctuation">,</span> getLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;log4js&quot;</span><span class="token punctuation">;</span>

<span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    appenders<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      cheese<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../logs/yd.log&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    categories<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> appenders<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>åœ¨ app ä¸­åŠ å…¥ logger</li> <li>æŒ‡å®šæ—¥å¿—çš„è¾“å‡ºä½ç½®</li></ul> <p>åœ¨ middleware ä¸‹åˆ›å»º errorHandler.tsï¼Œåˆ†åˆ«å¤„ç† 500 é”™è¯¯å’Œ 404 é”™è¯¯</p> <p>middleware/errorHandler.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// å®¹é”™å¤„ç†</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'koa'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'log4js'</span>

<span class="token keyword">const</span> errorHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">interface</span> <span class="token class-name">KOAContext</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">:</span> Logger
    <span class="token punctuation">}</span>

    <span class="token comment">// 500</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> KOAContext<span class="token punctuation">,</span> <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// error logs pm2 logs</span>
        ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> error<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> error <span class="token operator">||</span> <span class="token string">'è¯·æ±‚å‡ºé”™'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 404</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> KOAContext<span class="token punctuation">,</span> <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">404</span> <span class="token operator">!==</span> ctx<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token keyword">return</span>
      ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'&lt;script type=&quot;text/javascript&quot; src=&quot;//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js&quot; charset=&quot;utf-8&quot; homePageUrl=&quot;http://yoursite.com/yourPage.html&quot; homePageName=&quot;å›åˆ°æˆ‘çš„ä¸»é¡µ&quot;&gt;&lt;/script&gt;'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> errorHandler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>å®šä¹‰æ¥å£ <code>KOAContext</code></li> <li>å®šä¹‰ç›‘å¬ 500 çš„æœåŠ¡å™¨é”™è¯¯ï¼ŒæŠŠé”™è¯¯ä¿¡æ¯å†™åˆ°logé‡Œå»ï¼ŒåŒæ—¶æŠŠstatusè®¾ç½®æˆ500ï¼Œé€šçŸ¥é¡µé¢è¯·æ±‚å‡ºé”™</li> <li>å®šä¹‰ç›‘å¬ 404 çš„é”™è¯¯ï¼Œå†™å…¥logï¼ŒåŒæ—¶æŠŠé¡µé¢è½¬åˆ°404é¡µ</li></ul> <h2 id="æŠ½ç¦»ä¸­é—´ä»¶"><a href="#æŠ½ç¦»ä¸­é—´ä»¶" class="header-anchor">#</a> æŠ½ç¦»ä¸­é—´ä»¶</h2> <p>ä¸Šé¢å†™äº†ä¸€å¤§å¨ï¼Œéƒ½å†™åœ¨äº† app.ts ä¸­ï¼Œéå¸¸è‡ƒè‚¿ï¼Œå…¶å®å¯ä»¥æŠŠä»–ä»¬éƒ½æŠ½ç¦»å‡ºæ¥åˆ°ä¸€ä¸ªä¸­é—´ä»¶ä¸­ï¼Œä¾æ¬¡åŠ è½½</p> <p>app.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// åˆ›å»ºæœåŠ¡å®ä¾‹</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">æ•°æ®ç›‘æ§ç³»ç»ŸğŸºï¼Œserver is running on port</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>middleware/loadMiddleware.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> bodyParser <span class="token keyword">from</span> <span class="token string">&quot;koa-bodyparser&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-swig&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> serve <span class="token keyword">from</span> <span class="token string">&quot;koa-static&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> co <span class="token keyword">from</span> <span class="token string">&quot;co&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> configure<span class="token punctuation">,</span> getLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;log4js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> historyApiFallback <span class="token keyword">from</span> <span class="token string">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createContainer<span class="token punctuation">,</span> Lifetime<span class="token punctuation">,</span> asClass <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;awilix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IOC</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> loadControllers<span class="token punctuation">,</span> scopePerRequest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;awilix-koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IOC</span>

<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;../config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> errorHandler <span class="token keyword">from</span> <span class="token string">&quot;./errorHandler&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// åˆå§‹åŒ–IOCå®¹å™¨</span>
<span class="token keyword">const</span> <span class="token function-variable function">initIOC</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// åˆ›å»ºIOCçš„å®¹å™¨</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// æ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯ä¸€ä¸ªnew model</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">scopePerRequest</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// è£…è½½æ‰€æœ‰çš„service(models), å¹¶å°†servicesä»£ç æ³¨å…¥åˆ°controllers</span>
  container<span class="token punctuation">.</span><span class="token function">loadModules</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../service/*.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../util/SafeRequest.ts&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// we want `TodosService` to be registered as `todosService`.</span>
      formatName<span class="token punctuation">:</span> <span class="token string">&quot;camelCase&quot;</span><span class="token punctuation">,</span>
      resolverOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        lifetime<span class="token punctuation">:</span> Lifetime<span class="token punctuation">.</span><span class="token constant">SCOPED</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">/</span> é…ç½®log
<span class="token keyword">const</span> <span class="token function-variable function">initLog</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    appenders<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      cheese<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../logs/yd.log&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    categories<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> appenders<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>

  <span class="token operator">/</span><span class="token operator">/</span> é”™è¯¯å¤„ç†
  errorHandler<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">/</span> é…ç½®æ¸²æŸ“
<span class="token keyword">const</span> <span class="token function-variable function">initRender</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">/</span><span class="token operator">/</span> <span class="token function">é…ç½®swig</span><span class="token punctuation">(</span>å‰ç«¯æ¨¡æ¿<span class="token punctuation">)</span>
  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      root<span class="token punctuation">:</span> config<span class="token punctuation">.</span>viewDir<span class="token punctuation">,</span>
      autoescape<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      cache<span class="token punctuation">:</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">,</span>
      ext<span class="token punctuation">:</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span>
      varControls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;[[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]]&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> é»˜è®¤åŠ¨æ€æ•°æ®æ˜¯<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>ï¼Œä½†æ˜¯ä¸ºäº†ä¸vueåŒºåˆ†å¼€æ¥ï¼Œæ”¹ä¸º<span class="token punctuation">[</span><span class="token punctuation">[</span>xxx<span class="token punctuation">]</span><span class="token punctuation">]</span>
      writeBody<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">/</span><span class="token operator">/</span> é…ç½®é™æ€æ–‡ä»¶ç›®å½•
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">/</span> é…ç½®è·¯ç”±
<span class="token keyword">const</span> <span class="token function-variable function">initController</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">/</span><span class="token operator">/</span> æ³¨å†Œæ‰€æœ‰è·¯ç”±
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token function">loadControllers</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../controller/*.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      cwd<span class="token punctuation">:</span> __dirname
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> whiteList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initIOC</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initLog</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initController</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initRender</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><ul><li>å®šä¹‰äº†åˆå§‹åŒ–IOCå®¹å™¨ initIOC</li> <li>å®šä¹‰äº†é…ç½®logæ–¹æ³•</li> <li>å®šä¹‰äº†é…ç½®æ¸²æŸ“æ–¹æ³•</li> <li>å®šä¹‰äº†é…ç½®è·¯ç”±æ–¹æ³•</li> <li>æŒ‰é¡ºåºæ‰§è¡Œ</li></ul> <p>è‡³æ­¤ä¸€ä¸ªåŸºæœ¬çš„ MVC node ç«¯å·²ç»æ­å®Œï¼Œä¸‹ä¸€ç« è¿›è¡Œ SSR åŒæ„</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      â†
      <a href="/blog/2019-11-18-react.html" class="prev">å®æˆ˜ï¼ˆäºŒï¼‰react-hooksã€è·¯ç”±</a></span> <span class="next"><a href="/blog/2019-11-22-gulp.html">å®æˆ˜ï¼ˆå››ï¼‰ gulp æµæ¸…æ´—</a>
      â†’
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4d237ac1.js" defer></script><script src="/assets/js/2.a060ff2c.js" defer></script><script src="/assets/js/51.5f15d9c7.js" defer></script>
  </body>
</html>
