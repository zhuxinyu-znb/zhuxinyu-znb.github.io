<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实战（三） node中间层 | zxy的前端日志</title>
    <meta name="description" content="大前端之路开启">
    <link rel="icon" href="/tom.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.4d237ac1.js" as="script"><link rel="preload" href="/assets/js/2.a060ff2c.js" as="script"><link rel="preload" href="/assets/js/51.5f15d9c7.js" as="script"><link rel="prefetch" href="/assets/js/10.9b1783bd.js"><link rel="prefetch" href="/assets/js/100.f2ba88c1.js"><link rel="prefetch" href="/assets/js/101.5e4ff941.js"><link rel="prefetch" href="/assets/js/102.3b9faf71.js"><link rel="prefetch" href="/assets/js/103.ef114a14.js"><link rel="prefetch" href="/assets/js/104.038f45d3.js"><link rel="prefetch" href="/assets/js/105.5b457551.js"><link rel="prefetch" href="/assets/js/106.c1138d30.js"><link rel="prefetch" href="/assets/js/107.52f38a92.js"><link rel="prefetch" href="/assets/js/108.a794593b.js"><link rel="prefetch" href="/assets/js/109.18b69319.js"><link rel="prefetch" href="/assets/js/11.9c1e82ab.js"><link rel="prefetch" href="/assets/js/110.2261fb1b.js"><link rel="prefetch" href="/assets/js/111.00ccfb14.js"><link rel="prefetch" href="/assets/js/112.a9104a88.js"><link rel="prefetch" href="/assets/js/113.9f3a8f8a.js"><link rel="prefetch" href="/assets/js/114.206ecfeb.js"><link rel="prefetch" href="/assets/js/115.5745e2df.js"><link rel="prefetch" href="/assets/js/116.c1f7447b.js"><link rel="prefetch" href="/assets/js/117.9e065728.js"><link rel="prefetch" href="/assets/js/118.0f2d3691.js"><link rel="prefetch" href="/assets/js/119.6bea2203.js"><link rel="prefetch" href="/assets/js/12.67149a6a.js"><link rel="prefetch" href="/assets/js/120.32450f30.js"><link rel="prefetch" href="/assets/js/121.fee9f710.js"><link rel="prefetch" href="/assets/js/122.def18904.js"><link rel="prefetch" href="/assets/js/123.25039dca.js"><link rel="prefetch" href="/assets/js/124.c4050122.js"><link rel="prefetch" href="/assets/js/125.46b40dfe.js"><link rel="prefetch" href="/assets/js/126.51a1a5d8.js"><link rel="prefetch" href="/assets/js/127.7867f500.js"><link rel="prefetch" href="/assets/js/128.49de406e.js"><link rel="prefetch" href="/assets/js/129.cdf49571.js"><link rel="prefetch" href="/assets/js/13.fb79cecf.js"><link rel="prefetch" href="/assets/js/130.8b3710bf.js"><link rel="prefetch" href="/assets/js/131.36dfdd90.js"><link rel="prefetch" href="/assets/js/132.e44f7288.js"><link rel="prefetch" href="/assets/js/133.ec885b28.js"><link rel="prefetch" href="/assets/js/134.f1316579.js"><link rel="prefetch" href="/assets/js/135.ecf5779f.js"><link rel="prefetch" href="/assets/js/136.996ceb08.js"><link rel="prefetch" href="/assets/js/137.0b240ef8.js"><link rel="prefetch" href="/assets/js/138.de8c92b0.js"><link rel="prefetch" href="/assets/js/139.aa2176ad.js"><link rel="prefetch" href="/assets/js/14.7f7c1b73.js"><link rel="prefetch" href="/assets/js/140.5e8ac77c.js"><link rel="prefetch" href="/assets/js/141.abbc86d6.js"><link rel="prefetch" href="/assets/js/142.9174e4b3.js"><link rel="prefetch" href="/assets/js/143.22fd8bba.js"><link rel="prefetch" href="/assets/js/144.aed38b7d.js"><link rel="prefetch" href="/assets/js/145.a6813681.js"><link rel="prefetch" href="/assets/js/146.41a80028.js"><link rel="prefetch" href="/assets/js/147.ba1a7770.js"><link rel="prefetch" href="/assets/js/148.877bea00.js"><link rel="prefetch" href="/assets/js/149.27096d07.js"><link rel="prefetch" href="/assets/js/15.fbb3ce6c.js"><link rel="prefetch" href="/assets/js/150.4eb384a9.js"><link rel="prefetch" href="/assets/js/151.528f4deb.js"><link rel="prefetch" href="/assets/js/152.192e9a1f.js"><link rel="prefetch" href="/assets/js/153.a3b71eb6.js"><link rel="prefetch" href="/assets/js/154.df79b8cb.js"><link rel="prefetch" href="/assets/js/155.aec97f81.js"><link rel="prefetch" href="/assets/js/16.03657715.js"><link rel="prefetch" href="/assets/js/17.20cbf2da.js"><link rel="prefetch" href="/assets/js/18.12a5dc5c.js"><link rel="prefetch" href="/assets/js/19.726a67f7.js"><link rel="prefetch" href="/assets/js/20.836a5d40.js"><link rel="prefetch" href="/assets/js/21.c951da6e.js"><link rel="prefetch" href="/assets/js/22.87c90120.js"><link rel="prefetch" href="/assets/js/23.99c7dbfb.js"><link rel="prefetch" href="/assets/js/24.d8c6d636.js"><link rel="prefetch" href="/assets/js/25.bb1086c1.js"><link rel="prefetch" href="/assets/js/26.31634d99.js"><link rel="prefetch" href="/assets/js/27.2fb85e0f.js"><link rel="prefetch" href="/assets/js/28.696d685c.js"><link rel="prefetch" href="/assets/js/29.488210dd.js"><link rel="prefetch" href="/assets/js/3.78e42548.js"><link rel="prefetch" href="/assets/js/30.2ba4ba04.js"><link rel="prefetch" href="/assets/js/31.d141acc1.js"><link rel="prefetch" href="/assets/js/32.086dce6f.js"><link rel="prefetch" href="/assets/js/33.ed1968ff.js"><link rel="prefetch" href="/assets/js/34.77827aa7.js"><link rel="prefetch" href="/assets/js/35.d5b914d6.js"><link rel="prefetch" href="/assets/js/36.f9397b07.js"><link rel="prefetch" href="/assets/js/37.64beee5f.js"><link rel="prefetch" href="/assets/js/38.67130674.js"><link rel="prefetch" href="/assets/js/39.de9f3702.js"><link rel="prefetch" href="/assets/js/4.5197eef5.js"><link rel="prefetch" href="/assets/js/40.f23dcf4c.js"><link rel="prefetch" href="/assets/js/41.b6418c92.js"><link rel="prefetch" href="/assets/js/42.75dabff5.js"><link rel="prefetch" href="/assets/js/43.7e1d7e20.js"><link rel="prefetch" href="/assets/js/44.53712706.js"><link rel="prefetch" href="/assets/js/45.dafdeeff.js"><link rel="prefetch" href="/assets/js/46.66f32e9c.js"><link rel="prefetch" href="/assets/js/47.23958449.js"><link rel="prefetch" href="/assets/js/48.f4ec7b60.js"><link rel="prefetch" href="/assets/js/49.518f1bec.js"><link rel="prefetch" href="/assets/js/5.b26139fb.js"><link rel="prefetch" href="/assets/js/50.c8e8fb43.js"><link rel="prefetch" href="/assets/js/52.4db4cdfb.js"><link rel="prefetch" href="/assets/js/53.6af7b618.js"><link rel="prefetch" href="/assets/js/54.fec88fbe.js"><link rel="prefetch" href="/assets/js/55.a7e02100.js"><link rel="prefetch" href="/assets/js/56.67d70446.js"><link rel="prefetch" href="/assets/js/57.4866ef69.js"><link rel="prefetch" href="/assets/js/58.e6488e01.js"><link rel="prefetch" href="/assets/js/59.2467dc1e.js"><link rel="prefetch" href="/assets/js/6.b88b0bec.js"><link rel="prefetch" href="/assets/js/60.a4188798.js"><link rel="prefetch" href="/assets/js/61.b275a457.js"><link rel="prefetch" href="/assets/js/62.d6b63240.js"><link rel="prefetch" href="/assets/js/63.681f3d8b.js"><link rel="prefetch" href="/assets/js/64.9eeded5a.js"><link rel="prefetch" href="/assets/js/65.19721dd4.js"><link rel="prefetch" href="/assets/js/66.038614c3.js"><link rel="prefetch" href="/assets/js/67.d802f033.js"><link rel="prefetch" href="/assets/js/68.ce021a23.js"><link rel="prefetch" href="/assets/js/69.7ceca11e.js"><link rel="prefetch" href="/assets/js/7.0d983d99.js"><link rel="prefetch" href="/assets/js/70.f997d037.js"><link rel="prefetch" href="/assets/js/71.c1557031.js"><link rel="prefetch" href="/assets/js/72.2d9f5c4e.js"><link rel="prefetch" href="/assets/js/73.11ad7e38.js"><link rel="prefetch" href="/assets/js/74.eab8f5c6.js"><link rel="prefetch" href="/assets/js/75.e9fb6786.js"><link rel="prefetch" href="/assets/js/76.abdc4f64.js"><link rel="prefetch" href="/assets/js/77.dc44de72.js"><link rel="prefetch" href="/assets/js/78.ebf803d8.js"><link rel="prefetch" href="/assets/js/79.3228bce2.js"><link rel="prefetch" href="/assets/js/8.8a23a928.js"><link rel="prefetch" href="/assets/js/80.8c3fdc1e.js"><link rel="prefetch" href="/assets/js/81.f1472a60.js"><link rel="prefetch" href="/assets/js/82.95875586.js"><link rel="prefetch" href="/assets/js/83.6bfbbc19.js"><link rel="prefetch" href="/assets/js/84.91ade6f8.js"><link rel="prefetch" href="/assets/js/85.b5fdbf72.js"><link rel="prefetch" href="/assets/js/86.9d1404c5.js"><link rel="prefetch" href="/assets/js/87.0567def1.js"><link rel="prefetch" href="/assets/js/88.0763a6b6.js"><link rel="prefetch" href="/assets/js/89.b76800ed.js"><link rel="prefetch" href="/assets/js/9.11df2484.js"><link rel="prefetch" href="/assets/js/90.e9371a29.js"><link rel="prefetch" href="/assets/js/91.3abf758b.js"><link rel="prefetch" href="/assets/js/92.49121cc0.js"><link rel="prefetch" href="/assets/js/93.e7b2f6cc.js"><link rel="prefetch" href="/assets/js/94.c3307a0b.js"><link rel="prefetch" href="/assets/js/95.90dfe36e.js"><link rel="prefetch" href="/assets/js/96.4df4988a.js"><link rel="prefetch" href="/assets/js/97.60b1c42f.js"><link rel="prefetch" href="/assets/js/98.6394b8d8.js"><link rel="prefetch" href="/assets/js/99.98be11a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">zxy的前端日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/book/" class="nav-link">阅读</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">博客</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/book/" class="nav-link">阅读</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>PHP</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-05-28-php.html" class="sidebar-link">PHP学习(一) 基础语法</a></li><li><a href="/blog/2019-06-05-php&amp;mysql.html" class="sidebar-link">PHP学习(二) php与mysql</a></li><li><a href="/blog/2019-06-05-php_OOP_introduction.html" class="sidebar-link">PHP学习(三) php面向对象介绍</a></li><li><a href="/blog/2019-06-05-PHP_construct.html" class="sidebar-link">PHP学习(四) 构造方法和析构方法</a></li><li><a href="/blog/2019-06-10-OOP_fengzhuang.html" class="sidebar-link">PHP学习(五) PHP面向对象之封装性</a></li><li><a href="/blog/2019-06-10-OOP_jicheng_duotai.html" class="sidebar-link">PHP学习(六) PHP面向对象之继承与多态</a></li><li><a href="/blog/2019-06-10-OOP_interface_abstract.html" class="sidebar-link">PHP学习(七) PHP抽象类与接口</a></li><li><a href="/blog/2019-06-11-OPP_error.html" class="sidebar-link">PHP学习(八) PHP异常处理</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>node</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-06-25-node.html" class="sidebar-link">Node.js学习(基础)</a></li><li><a href="/blog/2019-06-26-express1.html" class="sidebar-link">express学习(一) express介绍</a></li><li><a href="/blog/2019-06-27-express-middleware.html" class="sidebar-link">express学习(二) 中间件</a></li><li><a href="/blog/2019-06-27-express-router.html" class="sidebar-link">express学习(三) 路由</a></li><li><a href="/blog/2019-06-27-express-error.html" class="sidebar-link">express学习(四) 错误处理</a></li><li><a href="/blog/2019-08-19-node.html" class="sidebar-link">大规模NodeJS项目架构与优化</a></li><li><a href="/blog/2019-08-20-node-pachong.html" class="sidebar-link">爬虫</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>工程化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-06-27-qa.html" class="sidebar-link">Javascript与QA工程师(一)</a></li><li><a href="/blog/2019-08-04-QA.html" class="sidebar-link">Javascript与QA工程师(二)</a></li><li><a href="/blog/2019-07-05-webpack1.html" class="sidebar-link">webpack4(一) webpack的核心概念</a></li><li><a href="/blog/2019-07-05-webpack2.html" class="sidebar-link">webpack4(二) webpack的高级概念</a></li><li><a href="/blog/2019-07-09-webpack3.html" class="sidebar-link">webpack4(三) webpack实战配置</a></li><li><a href="/blog/2019-07-10-webpack4.html" class="sidebar-link">webpack4(四) webpack底层原理及脚手架工具分析</a></li><li><a href="/blog/2019-08-28-gongchenghua1.html" class="sidebar-link">前端工程化Linux预备知识</a></li><li><a href="/blog/2019-08-29-jenkins.html" class="sidebar-link">前端工程化之CI&amp;CD --jenkins</a></li><li><a href="/blog/2019-09-02-chixujicheng.html" class="sidebar-link">从0到大论前端持续集成</a></li><li><a href="/blog/2019-09-02-mycli.html" class="sidebar-link">手写一个自己的cli</a></li><li><a href="/blog/2019-09-04-gulp.html" class="sidebar-link">构建工具</a></li><li><a href="/blog/2019-10-17-rongcuo.html" class="sidebar-link">容错</a></li><li><a href="/blog/2019-11-14-docker.html" class="sidebar-link">微服务入门与Docker实战</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-09-11-xingnengyouhua.html" class="sidebar-link">前端性能优化 服务器</a></li><li><a href="/blog/2019-09-12-yahujungui.html" class="sidebar-link">雅虎军规</a></li><li><a href="/blog/2019-09-16-xingnengyouhua.html" class="sidebar-link">前端架构与性能优化那些事儿</a></li><li><a href="/blog/2019-12-12-webpack.html" class="sidebar-link">webpack 性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>CSS</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-10-09-css-workflow.html" class="sidebar-link">现代化css方法论 CSS WorkFlow</a></li><li><a href="/blog/2019-10-10-css-hodini.html" class="sidebar-link">CSS魔术师Houdini</a></li><li><a href="/blog/2019-11-18-flex-css.html" class="sidebar-link">flex布局</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>js基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-12-02-es6-Map.html" class="sidebar-link">Set 和 Map</a></li><li><a href="/blog/2019-12-10-jicheng.html" class="sidebar-link">继承</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>编程基础</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-07-31-fp-.html" class="sidebar-link">函数式编程</a></li><li><a href="/blog/2019-10-20-sixiang.html" class="sidebar-link">面向切面的编程思想</a></li><li><a href="/blog/2020-01-05-shejimoshi.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Linux</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-05-27-Linux-instructions.html" class="sidebar-link">Linux常用指令</a></li><li><a href="/blog/2019-07-31-linux.html" class="sidebar-link">Linux预读</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>浏览器网络协议</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-08-14-http1.html" class="sidebar-link">HTTP协议那些事(一)</a></li><li><a href="/blog/2019-08-15-http2.html" class="sidebar-link">HTTP协议那些事(二)</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>数据结构与算法</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-12-06-data.html" class="sidebar-link">基础数据结构</a></li><li><a href="/blog/2019-12-04-sort.html" class="sidebar-link">排序算法</a></li><li><a href="/blog/2019-12-10-suanfa.html" class="sidebar-link">算法概论</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>图形学</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-12-15-canvas.html" class="sidebar-link">canvas 2d 入门</a></li><li><a href="/blog/2019-12-15-3d入门.html" class="sidebar-link">3D图形学入门</a></li><li><a href="/blog/2019-12-15-webgl1.html" class="sidebar-link">WebGL 概述</a></li><li><a href="/blog/2019-12-15-webgl入门.html" class="sidebar-link">WebGL 入门</a></li><li><a href="/blog/2020-09-16-three1.html" class="sidebar-link">threejs 入门（一）</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>electron</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2020-01-31-electron.html" class="sidebar-link">electron学习(一) 基础概念</a></li><li><a href="/blog/2020-02-01-electron.html" class="sidebar-link">electron学习(二) 环境配置</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>tensorflow</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2020-02-04-tensorflow.html" class="sidebar-link">神经网络</a></li><li><a href="/blog/2020-02-05-tensorflow.html" class="sidebar-link">线性回归任务</a></li><li><a href="/blog/2020-02-05-tensorflow2.html" class="sidebar-link">归一化任务</a></li><li><a href="/blog/2020-02-06-tensorflow.html" class="sidebar-link">逻辑回归任务</a></li><li><a href="/blog/2020-02-06-tensorflow2.html" class="sidebar-link">多层神经网络任务</a></li><li><a href="/blog/2020-02-07-tensorflow.html" class="sidebar-link">多分类任务</a></li><li><a href="/blog/2020-02-07-tensorflow2.html" class="sidebar-link">欠拟合与过拟合任务</a></li><li><a href="/blog/2020-02-08-tensorflow.html" class="sidebar-link">使用卷积神经网络识别手写数字任务</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>源码解读</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/2019-11-13-yuanmadu.html" class="sidebar-link">如何阅读源码</a></li><li><a href="/blog/react源码1.html" class="sidebar-link">React 源码解读（一）JSX</a></li><li><a href="/blog/react源码2.html" class="sidebar-link">React 源码解读（二） Fiber Root</a></li><li><a href="/blog/react源码3.html" class="sidebar-link">React 源码解读（三） requestWork</a></li><li><a href="/blog/react源码4.html" class="sidebar-link">React 源码解读（四） setState</a></li><li><a href="/blog/react源码5.html" class="sidebar-link">React 源码解读（五） hooks</a></li><li><a href="/blog/react源码6.html" class="sidebar-link">React 源码解读（六） hooks 原理（useState）</a></li><li><a href="/blog/2019-12-13-diff.html" class="sidebar-link">手写 Dom dff</a></li><li><a href="/blog/2019-11-27-webpack.html" class="sidebar-link">webpack源码（一）</a></li><li><a href="/blog/2019-12-01-webpack.html" class="sidebar-link">webpack源码（二）</a></li><li><a href="/blog/2019-12-04-koa.html" class="sidebar-link">手写 Koa</a></li><li><a href="/blog/2019-12-24-create-react-app.html" class="sidebar-link">create-react-app 源码分析</a></li><li><a href="/blog/2020-06-08-lottie.html" class="sidebar-link">lottie原理探索</a></li><li><a href="/blog/2020-06-30-vue源码.html" class="sidebar-link">Vue2源码解析</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>实战</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/webpack-0-1.html" class="sidebar-link">实战（一） webpack 环境搭建</a></li><li><a href="/blog/2019-11-18-react.html" class="sidebar-link">实战（二）react-hooks、路由</a></li><li><a href="/blog/2019-11-14-node.html" class="active sidebar-link">实战（三） node中间层</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#基础环境" class="sidebar-link">基础环境</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#创建ioc容器" class="sidebar-link">创建IOC容器</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#interface" class="sidebar-link">interface</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#service" class="sidebar-link">service</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#controller" class="sidebar-link">controller</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#渲染页面" class="sidebar-link">渲染页面</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#容错处理和日志" class="sidebar-link">容错处理和日志</a></li><li class="sidebar-sub-header"><a href="/blog/2019-11-14-node.html#抽离中间件" class="sidebar-link">抽离中间件</a></li></ul></li><li><a href="/blog/2019-11-22-gulp.html" class="sidebar-link">实战（四） gulp 流清洗</a></li><li><a href="/blog/2019-08-25-bff-shizhan.html" class="sidebar-link">BFF实战</a></li><li><a href="/blog/2019-09-07-webpack-shizhan.html" class="sidebar-link">工程化实战</a></li><li><a href="/blog/2019-10-10-xingnengyouhua-shizhan.html" class="sidebar-link">性能优化实战</a></li><li><a href="/blog/2019-10-14-xingnengyouhua-shizhan2.html" class="sidebar-link">性能优化实战(二)</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实战（三）-node中间层"><a href="#实战（三）-node中间层" class="header-anchor">#</a> 实战（三） node中间层</h1> <h2 id="基础环境"><a href="#基础环境" class="header-anchor">#</a> 基础环境</h2> <p>运行node端的ts需要全局安装 ts-node，对应着自动刷新的是 ts-node-dev</p> <p>安装 koa</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>安装 @types/koa</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>node端我们采用 MVC 的模式进行建立</p> <p>在src下创建server文件夹，具体目录结构如图</p> <p><img src="20191120-node1.png" alt="目录"></p> <p>先写一个简单的入口文件 app.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;hello koa&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">8888</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;数据监控系统🍺，server is running on port8888&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><ul><li>在ts中可以直接使用import</li> <li>用koa启动一个最基本的服务，可以在 localhost:8888 下看到 <code>hello koa</code></li></ul> <p>这里我们可以把端口号提出来，放在config中</p> <p>config/index.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> extend <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;lodash&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> join <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>

<span class="token keyword">interface</span> <span class="token class-name">configIn</span> <span class="token punctuation">{</span>
  viewDir<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  staticDir<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  env<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  port<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> config<span class="token punctuation">:</span> configIn <span class="token operator">=</span> <span class="token punctuation">{</span>
  viewDir<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;..&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;views&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  staticDir<span class="token punctuation">:</span> <span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;..&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;assets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  env<span class="token punctuation">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">&quot;development&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> <span class="token number">8081</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">==</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  config <span class="token operator">=</span> <span class="token function">extend</span><span class="token punctuation">(</span>config<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    port<span class="token punctuation">:</span> <span class="token number">80</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> config<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>这里我们安装 <code>lodash</code> 库做为工具库，使用<code>extend</code>方法来合并<code>port</code></li> <li>分别设置静态资源和页面的路径</li> <li>按环境变量不同分别设置开发环境和上线环境的端口</li></ul> <p>这样我们的app.ts就可以改成下面这样</p> <p>app.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 创建服务实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">&quot;hello koa&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">数据监控系统🍺，server is running on port</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>koa是一个非常精简的框架，不同于express，koa把所有的功能都拿了出去，通过插入不同的中间件来实现功能。</p> <p>安装 <code>koa-bodyparser</code> 和 <code>@types/koa-bodyparser</code> 来接收并解析请求</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa-bodyparser
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa-bodyparser --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在 app.ts 中引入</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> bodyParser <span class="token keyword">from</span> <span class="token string">&quot;koa-bodyparser&quot;</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>安装 <code>koa-static</code> 和 <code>@types/koa-static</code> 用来绑定静态资源</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa-static
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa-static --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这里直接使用IOC的方式来进行路由管理，就不使用 koa-route 了</p> <p>安装 <code>awilix</code> 和 <code>awilix-koa</code> 用来做容器管理</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add awilix awilix-koa
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="创建ioc容器"><a href="#创建ioc容器" class="header-anchor">#</a> 创建IOC容器</h2> <p>okk，接下来先创建容器吧</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'path'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createContainer<span class="token punctuation">,</span> Lifetime <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;awilix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span>loadControllers<span class="token punctuation">,</span> scopePerRequest<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'awilix-koa'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> historyApiFallback <span class="token keyword">from</span> <span class="token string">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 创建容器</span>
<span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 每次请求都是一个 new model</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">scopePerRequest</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 装载所有的service(models)，并将 services代码注入到controllers</span>
container<span class="token punctuation">.</span><span class="token function">loadModules</span><span class="token punctuation">(</span>
  <span class="token punctuation">[</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./service/*.ts'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./util/SafeRequest.ts'</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    formatName<span class="token punctuation">:</span> <span class="token string">'camelCase'</span><span class="token punctuation">,</span>
    resolveOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      lifetime<span class="token punctuation">:</span> Lifetime<span class="token punctuation">.</span><span class="token constant">SCOPED</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
<span class="token comment">//注册所有路由</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">loadControllers</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../controller/*.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    cwd<span class="token punctuation">:</span> __dirname
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> whiteList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><ul><li>通过 <code>createContainer</code> 创建容器</li> <li>用 <code>scopePerRequest</code> 把容器和路由最终合并到一起，每次请求都去容器里去取</li> <li><code>loadModules</code> 把所有的 <code>service</code> 注入到容器中</li> <li><code>loadControllers</code> 注册所有路由</li> <li>historyApiFallback 用于让koa2支持SPA应用程序。</li></ul> <h2 id="interface"><a href="#interface" class="header-anchor">#</a> interface</h2> <p>先在 <code>interface</code> 下写几个接口文件，别管干啥的，先放着 ╮(╯▽╰)╭</p> <p>interface/IApi.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IApi</span> <span class="token punctuation">{</span>
  <span class="token function">getInfo</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>interface/IIndex.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> User <span class="token keyword">from</span> <span class="token string">'../model/user'</span>

<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">IIdex</span> <span class="token punctuation">{</span>
  <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> User
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>model/user</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    email<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
    name<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>interface/ISafeRequest.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ISafeRequest</span> <span class="token punctuation">{</span>
  <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>interface/ISocketHandler.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ISocketHandler</span> <span class="token punctuation">{</span>
  <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">void</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="service"><a href="#service" class="header-anchor">#</a> service</h2> <p>接下来写两个 <code>service</code></p> <p>service/IndexService.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> IIdex <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/IIndex'</span>
<span class="token keyword">import</span> User <span class="token keyword">from</span> <span class="token string">'../model/User'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">IndexService</span> <span class="token keyword">implements</span> <span class="token class-name">IIdex</span> <span class="token punctuation">{</span>
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

  <span class="token keyword">private</span> userStorage<span class="token punctuation">:</span> User<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      email<span class="token punctuation">:</span> <span class="token string">&quot;yuanzhijia@yidengfe.com&quot;</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;zhijia&quot;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      email<span class="token punctuation">:</span> <span class="token string">&quot;Copyright © 2016 yidengfe.com All Rights Reversed.京ICP备16022242号-1&quot;</span><span class="token punctuation">,</span>
      name<span class="token punctuation">:</span> <span class="token string">&quot;laowang&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>

  <span class="token keyword">public</span> <span class="token function">getUser</span><span class="token punctuation">(</span>id<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token punctuation">:</span> User <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result<span class="token punctuation">:</span> User

    result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>userStorage<span class="token punctuation">[</span>id<span class="token punctuation">]</span>
    
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><ul><li>注意在写 <code>service</code> 时的命名要用大驼峰，后面在 <code>controller</code> 中要对应好，使用小驼峰</li> <li>在这里定义用户信息</li></ul> <p>service/ApiService.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// import safeRequest from '../util/SafeRequest'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/IApi'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ApiService</span> <span class="token keyword">implements</span> <span class="token class-name">IApi</span> <span class="token punctuation">{</span>
  
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> safeRequest <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>safeRequest <span class="token operator">=</span> safeRequest
  <span class="token punctuation">}</span>

  <span class="token keyword">public</span> <span class="token function">getInfo</span><span class="token punctuation">(</span>url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span> callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span><span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>safeRequest<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> arg<span class="token punctuation">,</span> callback<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><ul><li>前面在注入的时候，已经将 <code>SafeRequest</code> 方法注入到容器中了，在这里直接结构出来，使用 <code>getInfo</code> 方法调用</li></ul> <p>SafeRequest.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> fetch <span class="token keyword">from</span> <span class="token string">'node-fetch'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> ISafeRequest <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/ISafeRequest'</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">SafeRequest</span> <span class="token keyword">implements</span> <span class="token class-name">ISafeRequest</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token function">fetch</span><span class="token punctuation">(</span>
    url<span class="token punctuation">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span>
    arg<span class="token operator">?</span><span class="token punctuation">:</span> Object<span class="token punctuation">,</span>
    callback<span class="token operator">?</span><span class="token punctuation">:</span> <span class="token builtin">Function</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">{</span> code<span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">await</span> <span class="token function">fetch</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> res<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">json</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span>result <span class="token operator">=</span> json<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><h2 id="controller"><a href="#controller" class="header-anchor">#</a> controller</h2> <p>接下来就是重头戏 <code>controller</code></p> <p>写两个 <code>controller</code></p> <p>controller/IndexController.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Router <span class="token keyword">from</span> <span class="token string">&quot;koa-router&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> route<span class="token punctuation">,</span> <span class="token constant">GET</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;awilix-koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> User <span class="token keyword">from</span> <span class="token string">&quot;../model/User&quot;</span><span class="token punctuation">;</span>

@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/index&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">IndexController</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> indexService
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> indexService <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>indexService <span class="token operator">=</span> indexService<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  @<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">)</span>
  @<span class="token constant">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">:</span> Router<span class="token punctuation">.</span>IRouterContext<span class="token punctuation">,</span>
    <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result<span class="token punctuation">:</span> User <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>indexService<span class="token punctuation">.</span><span class="token function">getUser</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> data<span class="token punctuation">:</span> result<span class="token punctuation">.</span>email <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><ul><li>引入了 koa-router 要记得安装一下，为了给 ctx 添加类型检测</li> <li>在构造函数中结构出 <code>indexService</code>，记得名字要跟 service 文件名对上，大小写注意</li> <li>然后要绑定路由，从 <code>awilix-koa</code> 引入的 <code>route</code> 和 <code>GET</code> 方法直接通过装饰器的方式将路由注入进去</li> <li>同一个类或方法上面可以用多个装饰器，@route(&quot;/&quot;) 和 @GET() 表示在 '/' 路由时通过 get 请求接口</li></ul> <p>controller/ApiController.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Router <span class="token keyword">from</span> <span class="token string">'koa-router'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> route<span class="token punctuation">,</span> <span class="token constant">GET</span> <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'awilix-koa'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> IApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'../interface/IApi'</span>

@<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/api'</span><span class="token punctuation">)</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">ApiController</span> <span class="token punctuation">{</span>
  <span class="token keyword">private</span> apiService
  <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> apiService <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>apiService <span class="token operator">=</span> apiService
  <span class="token punctuation">}</span>
  @<span class="token function">route</span><span class="token punctuation">(</span><span class="token string">'/test'</span><span class="token punctuation">)</span>
  @<span class="token constant">GET</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">private</span> <span class="token keyword">async</span> <span class="token function">test</span><span class="token punctuation">(</span>
    ctx<span class="token punctuation">:</span> Router<span class="token punctuation">.</span>IRouterContext<span class="token punctuation">,</span>
    <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span>
  <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> result<span class="token punctuation">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Object<span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span>apiService<span class="token punctuation">.</span><span class="token function">getInfo</span><span class="token punctuation">(</span><span class="token string">'https://api.github.com/users/github'</span><span class="token punctuation">)</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><ul><li>定义几个数据接口</li> <li>接收前端的接口请求，然后去后端地址请求数据回来，再返回给前端</li></ul> <p>至此，一个基本的已经搭起来了。</p> <p>启动服务，先打开 localhost:8081/api/test，可以看到拿到了请求的数据</p> <p><img src="20191121-node1.png" alt="api"></p> <h2 id="渲染页面"><a href="#渲染页面" class="header-anchor">#</a> 渲染页面</h2> <p>通过 swig 模板引擎进行渲染页面。当然实际上我们是用react进行页面的绘制，这里先通过后端渲染上来，后面会做ssr同构。</p> <p>安装 koa-swig koa-static co @types/co @types/koa-static</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add koa-swig koa-static
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add @types/koa-static @types/co --dev
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> render <span class="token keyword">from</span> <span class="token string">&quot;koa-swig&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> serve <span class="token keyword">from</span> <span class="token string">&quot;koa-static&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> co <span class="token keyword">from</span> <span class="token string">&quot;co&quot;</span><span class="token punctuation">;</span>
<span class="token comment">//配置swig(前端模板)</span>
  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      root<span class="token punctuation">:</span> config<span class="token punctuation">.</span>viewDir<span class="token punctuation">,</span>
      autoescape<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      cache<span class="token punctuation">:</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">,</span>
      ext<span class="token punctuation">:</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span>
      writeBody<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//配置静态文件目录</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><ul><li>在app上绑定 <code>render</code> 方法</li> <li>root 指定根路径</li> <li>通过 serve 配置静态文件目录</li></ul> <h2 id="容错处理和日志"><a href="#容错处理和日志" class="header-anchor">#</a> 容错处理和日志</h2> <p>接下来该添加日志了和做一些容错处理了。</p> <p>首先安装 <code>log4js</code></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>yarn add log4js
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>在 app 上挂载 logger</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> configure<span class="token punctuation">,</span> getLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;log4js&quot;</span><span class="token punctuation">;</span>

<span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    appenders<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      cheese<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../logs/yd.log&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    categories<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> appenders<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li>在 app 中加入 logger</li> <li>指定日志的输出位置</li></ul> <p>在 middleware 下创建 errorHandler.ts，分别处理 500 错误和 404 错误</p> <p>middleware/errorHandler.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token comment">// 容错处理</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Context <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'koa'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> Logger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'log4js'</span>

<span class="token keyword">const</span> errorHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function">error</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">interface</span> <span class="token class-name">KOAContext</span> <span class="token keyword">extends</span> <span class="token class-name">Context</span> <span class="token punctuation">{</span>
      logger<span class="token punctuation">:</span> Logger
    <span class="token punctuation">}</span>

    <span class="token comment">// 500</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> KOAContext<span class="token punctuation">,</span> <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// error logs pm2 logs</span>
        ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> error<span class="token punctuation">.</span>status <span class="token operator">||</span> <span class="token number">500</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> error <span class="token operator">||</span> <span class="token string">'请求出错'</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token comment">// 404</span>
    app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">:</span> KOAContext<span class="token punctuation">,</span> <span class="token function-variable function">next</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">404</span> <span class="token operator">!==</span> ctx<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token keyword">return</span>
      ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
      ctx<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token number">404</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'&lt;script type=&quot;text/javascript&quot; src=&quot;//qzonestyle.gtimg.cn/qzone/hybrid/app/404/search_children.js&quot; charset=&quot;utf-8&quot; homePageUrl=&quot;http://yoursite.com/yourPage.html&quot; homePageName=&quot;回到我的主页&quot;&gt;&lt;/script&gt;'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> errorHandler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><ul><li>定义接口 <code>KOAContext</code></li> <li>定义监听 500 的服务器错误，把错误信息写到log里去，同时把status设置成500，通知页面请求出错</li> <li>定义监听 404 的错误，写入log，同时把页面转到404页</li></ul> <h2 id="抽离中间件"><a href="#抽离中间件" class="header-anchor">#</a> 抽离中间件</h2> <p>上面写了一大坨，都写在了 app.ts 中，非常臃肿，其实可以把他们都抽离出来到一个中间件中，依次加载</p> <p>app.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> Koa <span class="token keyword">from</span> <span class="token string">&quot;koa&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;./config&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 创建服务实例</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>port<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">数据监控系统🍺，server is running on port</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>config<span class="token punctuation">.</span>port<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>middleware/loadMiddleware.ts</p> <div class="language-ts line-numbers-mode"><pre class="language-ts"><code><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> bodyParser <span class="token keyword">from</span> <span class="token string">&quot;koa-bodyparser&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> render <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;koa-swig&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> serve <span class="token keyword">from</span> <span class="token string">&quot;koa-static&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> co <span class="token keyword">from</span> <span class="token string">&quot;co&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> configure<span class="token punctuation">,</span> getLogger <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;log4js&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> resolve <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;path&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> historyApiFallback <span class="token keyword">from</span> <span class="token string">&quot;koa2-connect-history-api-fallback&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> createContainer<span class="token punctuation">,</span> Lifetime<span class="token punctuation">,</span> asClass <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;awilix&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IOC</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> loadControllers<span class="token punctuation">,</span> scopePerRequest <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">&quot;awilix-koa&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// IOC</span>

<span class="token keyword">import</span> config <span class="token keyword">from</span> <span class="token string">&quot;../config&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> errorHandler <span class="token keyword">from</span> <span class="token string">&quot;./errorHandler&quot;</span><span class="token punctuation">;</span>

<span class="token comment">// 初始化IOC容器</span>
<span class="token keyword">const</span> <span class="token function-variable function">initIOC</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 创建IOC的容器</span>
  <span class="token keyword">const</span> container <span class="token operator">=</span> <span class="token function">createContainer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 每一次请求都是一个new model</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">scopePerRequest</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 装载所有的service(models), 并将services代码注入到controllers</span>
  container<span class="token punctuation">.</span><span class="token function">loadModules</span><span class="token punctuation">(</span>
    <span class="token punctuation">[</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../service/*.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../util/SafeRequest.ts&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      <span class="token comment">// we want `TodosService` to be registered as `todosService`.</span>
      formatName<span class="token punctuation">:</span> <span class="token string">&quot;camelCase&quot;</span><span class="token punctuation">,</span>
      resolverOptions<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        lifetime<span class="token punctuation">:</span> Lifetime<span class="token punctuation">.</span><span class="token constant">SCOPED</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">/</span> 配置log
<span class="token keyword">const</span> <span class="token function-variable function">initLog</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">configure</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    appenders<span class="token punctuation">:</span> <span class="token punctuation">{</span>
      cheese<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">type</span><span class="token punctuation">:</span> <span class="token string">&quot;file&quot;</span><span class="token punctuation">,</span> filename<span class="token punctuation">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../logs/yd.log&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    categories<span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> appenders<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> level<span class="token punctuation">:</span> <span class="token string">&quot;error&quot;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> logger <span class="token operator">=</span> <span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token string">&quot;cheese&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>logger <span class="token operator">=</span> logger<span class="token punctuation">;</span>

  <span class="token operator">/</span><span class="token operator">/</span> 错误处理
  errorHandler<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">/</span> 配置渲染
<span class="token keyword">const</span> <span class="token function-variable function">initRender</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">/</span><span class="token operator">/</span> <span class="token function">配置swig</span><span class="token punctuation">(</span>前端模板<span class="token punctuation">)</span>
  app<span class="token punctuation">.</span>context<span class="token punctuation">.</span>render <span class="token operator">=</span> co<span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>
    <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      root<span class="token punctuation">:</span> config<span class="token punctuation">.</span>viewDir<span class="token punctuation">,</span>
      autoescape<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      cache<span class="token punctuation">:</span> <span class="token string">&quot;memory&quot;</span><span class="token punctuation">,</span>
      ext<span class="token punctuation">:</span> <span class="token string">&quot;html&quot;</span><span class="token punctuation">,</span>
      varControls<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;[[&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;]]&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token operator">/</span><span class="token operator">/</span> 默认动态数据是<span class="token punctuation">{</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">}</span>，但是为了与vue区分开来，改为<span class="token punctuation">[</span><span class="token punctuation">[</span>xxx<span class="token punctuation">]</span><span class="token punctuation">]</span>
      writeBody<span class="token punctuation">:</span> <span class="token boolean">false</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token operator">/</span><span class="token operator">/</span> 配置静态文件目录
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">serve</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>staticDir<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token operator">/</span><span class="token operator">/</span> 配置路由
<span class="token keyword">const</span> <span class="token function-variable function">initController</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token operator">/</span><span class="token operator">/</span> 注册所有路由
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
    <span class="token function">loadControllers</span><span class="token punctuation">(</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../controller/*.ts&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      cwd<span class="token punctuation">:</span> __dirname
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">historyApiFallback</span><span class="token punctuation">(</span><span class="token punctuation">{</span> index<span class="token punctuation">:</span> <span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> whiteList<span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">&quot;/api&quot;</span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token parameter">app</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token function">bodyParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initIOC</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initLog</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initController</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">initRender</span><span class="token punctuation">(</span>app<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br></div></div><ul><li>定义了初始化IOC容器 initIOC</li> <li>定义了配置log方法</li> <li>定义了配置渲染方法</li> <li>定义了配置路由方法</li> <li>按顺序执行</li></ul> <p>至此一个基本的 MVC node 端已经搭完，下一章进行 SSR 同构</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/2019-11-18-react.html" class="prev">实战（二）react-hooks、路由</a></span> <span class="next"><a href="/blog/2019-11-22-gulp.html">实战（四） gulp 流清洗</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4d237ac1.js" defer></script><script src="/assets/js/2.a060ff2c.js" defer></script><script src="/assets/js/51.5f15d9c7.js" defer></script>
  </body>
</html>
