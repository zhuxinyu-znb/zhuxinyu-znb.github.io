<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>《狼书-更了不起的 nodejs》 | zxy的前端日志</title>
    <meta name="description" content="大前端之路开启">
    <link rel="icon" href="/tom.jpg">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.4d237ac1.js" as="script"><link rel="preload" href="/assets/js/2.a060ff2c.js" as="script"><link rel="preload" href="/assets/js/124.c4050122.js" as="script"><link rel="prefetch" href="/assets/js/10.9b1783bd.js"><link rel="prefetch" href="/assets/js/100.f2ba88c1.js"><link rel="prefetch" href="/assets/js/101.5e4ff941.js"><link rel="prefetch" href="/assets/js/102.3b9faf71.js"><link rel="prefetch" href="/assets/js/103.ef114a14.js"><link rel="prefetch" href="/assets/js/104.038f45d3.js"><link rel="prefetch" href="/assets/js/105.5b457551.js"><link rel="prefetch" href="/assets/js/106.c1138d30.js"><link rel="prefetch" href="/assets/js/107.52f38a92.js"><link rel="prefetch" href="/assets/js/108.a794593b.js"><link rel="prefetch" href="/assets/js/109.18b69319.js"><link rel="prefetch" href="/assets/js/11.9c1e82ab.js"><link rel="prefetch" href="/assets/js/110.2261fb1b.js"><link rel="prefetch" href="/assets/js/111.00ccfb14.js"><link rel="prefetch" href="/assets/js/112.a9104a88.js"><link rel="prefetch" href="/assets/js/113.9f3a8f8a.js"><link rel="prefetch" href="/assets/js/114.206ecfeb.js"><link rel="prefetch" href="/assets/js/115.5745e2df.js"><link rel="prefetch" href="/assets/js/116.c1f7447b.js"><link rel="prefetch" href="/assets/js/117.9e065728.js"><link rel="prefetch" href="/assets/js/118.0f2d3691.js"><link rel="prefetch" href="/assets/js/119.6bea2203.js"><link rel="prefetch" href="/assets/js/12.67149a6a.js"><link rel="prefetch" href="/assets/js/120.32450f30.js"><link rel="prefetch" href="/assets/js/121.fee9f710.js"><link rel="prefetch" href="/assets/js/122.def18904.js"><link rel="prefetch" href="/assets/js/123.25039dca.js"><link rel="prefetch" href="/assets/js/125.46b40dfe.js"><link rel="prefetch" href="/assets/js/126.51a1a5d8.js"><link rel="prefetch" href="/assets/js/127.7867f500.js"><link rel="prefetch" href="/assets/js/128.49de406e.js"><link rel="prefetch" href="/assets/js/129.cdf49571.js"><link rel="prefetch" href="/assets/js/13.fb79cecf.js"><link rel="prefetch" href="/assets/js/130.8b3710bf.js"><link rel="prefetch" href="/assets/js/131.36dfdd90.js"><link rel="prefetch" href="/assets/js/132.e44f7288.js"><link rel="prefetch" href="/assets/js/133.ec885b28.js"><link rel="prefetch" href="/assets/js/134.f1316579.js"><link rel="prefetch" href="/assets/js/135.ecf5779f.js"><link rel="prefetch" href="/assets/js/136.996ceb08.js"><link rel="prefetch" href="/assets/js/137.0b240ef8.js"><link rel="prefetch" href="/assets/js/138.de8c92b0.js"><link rel="prefetch" href="/assets/js/139.aa2176ad.js"><link rel="prefetch" href="/assets/js/14.7f7c1b73.js"><link rel="prefetch" href="/assets/js/140.5e8ac77c.js"><link rel="prefetch" href="/assets/js/141.abbc86d6.js"><link rel="prefetch" href="/assets/js/142.9174e4b3.js"><link rel="prefetch" href="/assets/js/143.22fd8bba.js"><link rel="prefetch" href="/assets/js/144.aed38b7d.js"><link rel="prefetch" href="/assets/js/145.a6813681.js"><link rel="prefetch" href="/assets/js/146.41a80028.js"><link rel="prefetch" href="/assets/js/147.ba1a7770.js"><link rel="prefetch" href="/assets/js/148.877bea00.js"><link rel="prefetch" href="/assets/js/149.27096d07.js"><link rel="prefetch" href="/assets/js/15.fbb3ce6c.js"><link rel="prefetch" href="/assets/js/150.4eb384a9.js"><link rel="prefetch" href="/assets/js/151.528f4deb.js"><link rel="prefetch" href="/assets/js/152.192e9a1f.js"><link rel="prefetch" href="/assets/js/153.a3b71eb6.js"><link rel="prefetch" href="/assets/js/154.df79b8cb.js"><link rel="prefetch" href="/assets/js/155.aec97f81.js"><link rel="prefetch" href="/assets/js/16.03657715.js"><link rel="prefetch" href="/assets/js/17.20cbf2da.js"><link rel="prefetch" href="/assets/js/18.12a5dc5c.js"><link rel="prefetch" href="/assets/js/19.726a67f7.js"><link rel="prefetch" href="/assets/js/20.836a5d40.js"><link rel="prefetch" href="/assets/js/21.c951da6e.js"><link rel="prefetch" href="/assets/js/22.87c90120.js"><link rel="prefetch" href="/assets/js/23.99c7dbfb.js"><link rel="prefetch" href="/assets/js/24.d8c6d636.js"><link rel="prefetch" href="/assets/js/25.bb1086c1.js"><link rel="prefetch" href="/assets/js/26.31634d99.js"><link rel="prefetch" href="/assets/js/27.2fb85e0f.js"><link rel="prefetch" href="/assets/js/28.696d685c.js"><link rel="prefetch" href="/assets/js/29.488210dd.js"><link rel="prefetch" href="/assets/js/3.78e42548.js"><link rel="prefetch" href="/assets/js/30.2ba4ba04.js"><link rel="prefetch" href="/assets/js/31.d141acc1.js"><link rel="prefetch" href="/assets/js/32.086dce6f.js"><link rel="prefetch" href="/assets/js/33.ed1968ff.js"><link rel="prefetch" href="/assets/js/34.77827aa7.js"><link rel="prefetch" href="/assets/js/35.d5b914d6.js"><link rel="prefetch" href="/assets/js/36.f9397b07.js"><link rel="prefetch" href="/assets/js/37.64beee5f.js"><link rel="prefetch" href="/assets/js/38.67130674.js"><link rel="prefetch" href="/assets/js/39.de9f3702.js"><link rel="prefetch" href="/assets/js/4.5197eef5.js"><link rel="prefetch" href="/assets/js/40.f23dcf4c.js"><link rel="prefetch" href="/assets/js/41.b6418c92.js"><link rel="prefetch" href="/assets/js/42.75dabff5.js"><link rel="prefetch" href="/assets/js/43.7e1d7e20.js"><link rel="prefetch" href="/assets/js/44.53712706.js"><link rel="prefetch" href="/assets/js/45.dafdeeff.js"><link rel="prefetch" href="/assets/js/46.66f32e9c.js"><link rel="prefetch" href="/assets/js/47.23958449.js"><link rel="prefetch" href="/assets/js/48.f4ec7b60.js"><link rel="prefetch" href="/assets/js/49.518f1bec.js"><link rel="prefetch" href="/assets/js/5.b26139fb.js"><link rel="prefetch" href="/assets/js/50.c8e8fb43.js"><link rel="prefetch" href="/assets/js/51.5f15d9c7.js"><link rel="prefetch" href="/assets/js/52.4db4cdfb.js"><link rel="prefetch" href="/assets/js/53.6af7b618.js"><link rel="prefetch" href="/assets/js/54.fec88fbe.js"><link rel="prefetch" href="/assets/js/55.a7e02100.js"><link rel="prefetch" href="/assets/js/56.67d70446.js"><link rel="prefetch" href="/assets/js/57.4866ef69.js"><link rel="prefetch" href="/assets/js/58.e6488e01.js"><link rel="prefetch" href="/assets/js/59.2467dc1e.js"><link rel="prefetch" href="/assets/js/6.b88b0bec.js"><link rel="prefetch" href="/assets/js/60.a4188798.js"><link rel="prefetch" href="/assets/js/61.b275a457.js"><link rel="prefetch" href="/assets/js/62.d6b63240.js"><link rel="prefetch" href="/assets/js/63.681f3d8b.js"><link rel="prefetch" href="/assets/js/64.9eeded5a.js"><link rel="prefetch" href="/assets/js/65.19721dd4.js"><link rel="prefetch" href="/assets/js/66.038614c3.js"><link rel="prefetch" href="/assets/js/67.d802f033.js"><link rel="prefetch" href="/assets/js/68.ce021a23.js"><link rel="prefetch" href="/assets/js/69.7ceca11e.js"><link rel="prefetch" href="/assets/js/7.0d983d99.js"><link rel="prefetch" href="/assets/js/70.f997d037.js"><link rel="prefetch" href="/assets/js/71.c1557031.js"><link rel="prefetch" href="/assets/js/72.2d9f5c4e.js"><link rel="prefetch" href="/assets/js/73.11ad7e38.js"><link rel="prefetch" href="/assets/js/74.eab8f5c6.js"><link rel="prefetch" href="/assets/js/75.e9fb6786.js"><link rel="prefetch" href="/assets/js/76.abdc4f64.js"><link rel="prefetch" href="/assets/js/77.dc44de72.js"><link rel="prefetch" href="/assets/js/78.ebf803d8.js"><link rel="prefetch" href="/assets/js/79.3228bce2.js"><link rel="prefetch" href="/assets/js/8.8a23a928.js"><link rel="prefetch" href="/assets/js/80.8c3fdc1e.js"><link rel="prefetch" href="/assets/js/81.f1472a60.js"><link rel="prefetch" href="/assets/js/82.95875586.js"><link rel="prefetch" href="/assets/js/83.6bfbbc19.js"><link rel="prefetch" href="/assets/js/84.91ade6f8.js"><link rel="prefetch" href="/assets/js/85.b5fdbf72.js"><link rel="prefetch" href="/assets/js/86.9d1404c5.js"><link rel="prefetch" href="/assets/js/87.0567def1.js"><link rel="prefetch" href="/assets/js/88.0763a6b6.js"><link rel="prefetch" href="/assets/js/89.b76800ed.js"><link rel="prefetch" href="/assets/js/9.11df2484.js"><link rel="prefetch" href="/assets/js/90.e9371a29.js"><link rel="prefetch" href="/assets/js/91.3abf758b.js"><link rel="prefetch" href="/assets/js/92.49121cc0.js"><link rel="prefetch" href="/assets/js/93.e7b2f6cc.js"><link rel="prefetch" href="/assets/js/94.c3307a0b.js"><link rel="prefetch" href="/assets/js/95.90dfe36e.js"><link rel="prefetch" href="/assets/js/96.4df4988a.js"><link rel="prefetch" href="/assets/js/97.60b1c42f.js"><link rel="prefetch" href="/assets/js/98.6394b8d8.js"><link rel="prefetch" href="/assets/js/99.98be11a9.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">zxy的前端日志</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/book/" class="nav-link router-link-active">阅读</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">博客</a></div><div class="nav-item"><a href="/interview/" class="nav-link">面试题</a></div><div class="nav-item"><a href="/book/" class="nav-link router-link-active">阅读</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>技术相关</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/" class="sidebar-link">阅读</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="《狼书-更了不起的-nodejs》"><a href="#《狼书-更了不起的-nodejs》" class="header-anchor">#</a> 《狼书-更了不起的 nodejs》</h1> <p>最近读了狼叔的新书，《狼书-更了不起的 nodejs》感觉挺基础的，最难的地方在于 nodejs 运行过程一章，在这记录一下。</p> <ul><li>Nodejs 应用场景</li> <li>单线程会死吗</li> <li>编译三步走</li> <li>Nodejs 是如何执行的</li> <li>Buffer</li> <li>Streams</li> <li>Nodejs 异步写法与流程控制</li></ul> <h2 id="nodejs-应用场景"><a href="#nodejs-应用场景" class="header-anchor">#</a> Nodejs 应用场景</h2> <ul><li>反向代理
<ul><li>nodejs 可以像 nginx 一样，作为反向代理。</li></ul></li> <li>爬虫
<ul><li>npm 库里有大量爬虫相关的模块，node-crawler 等，配合 jsdom，对前端非常友好。</li></ul></li> <li>命令行工具
<ul><li>所有辅助开发、运维、提高效率的工具，都可以用 nodejs 来开发</li></ul></li> <li>微服务和 rpc
<ul><li>nodejs 里有各种 rpc，比如 dnode、seneca，也有跨语言支持的 gRPC。</li></ul></li> <li>微信公众号开发
<ul><li>相关 sdk，框架非常多，是快速开发的利器。</li></ul></li> <li>前端流行的 ssr 和 pwa
<ul><li>ssr 是服务器端渲染，react 和 vue 都可以用 nodejs 实现 ssr。</li> <li>pwa 的很多模块也是用 nodejs 实现的。</li></ul></li></ul> <h2 id="单线程会死吗"><a href="#单线程会死吗" class="header-anchor">#</a> 单线程会死吗</h2> <p>单线程非常脆弱，随便一点异常都会使其“挂掉”，不幸的是 Node.js 就是单线程的，所以经常被人诟病“太脆弱，动不动就崩溃”。但是，真的是这样的吗？</p> <p>单线程会死是一个伪命题，大部分时候是用法不当造成的。通常可以通过如下方案解决：</p> <ul><li>uncaughtException
<ul><li>全局异常捕获，可以 catch 到所有导致系统崩溃的问题。</li></ul></li> <li>pm2
<ul><li>进程因异常退出是很常见的事，当遇到崩溃退出的时候，重启就可以了。</li> <li>pm2 还支持多核部署，即在 cpu 每个核上都运行一个服务，如遇到退出，则会重启。</li></ul></li> <li>部署多台服务器集群，将概率降到最小。</li></ul> <h2 id="编译三步走"><a href="#编译三步走" class="header-anchor">#</a> 编译三步走</h2> <p>书中从 nodejs 源码编译开始，讲解了 node 运行过程，这里先介绍一下常规的编译三步走。</p> <ul><li>./configure</li> <li>make</li> <li>make install</li></ul> <p>1、./configure 是用来检测你的安装平台的目标特征的。比如它会检测你是不是有 CC 或 GCC，并不是需要 CC 或 GCC，它是个 shell 脚本。</p> <p>2、make 是用来编译的，它从 Makefile 中读取指令，然后编译。</p> <p>3、make install 是用来安装的，它也从 Makefile 中读取指令，安装到指定的位置。</p> <h3 id="configure-命令"><a href="#configure-命令" class="header-anchor">#</a> configure 命令</h3> <p>configure 命令一般用来生成 Makefile，为下一步的编译做准备，你可以通过在 configure 后加上参数来对安装进行控制，比如代码:<code>./configure –prefix=/usr</code> 意思是将该软件安装在 /usr 下面，执行文件就会安装在 /usr/bin（而不是默认的 /usr/local/bin)，资源文件就会安装在 /usr/share（而不是默认的/usr/local/share）。</p> <p>同时一些软件的配置文件你可以通过指定 –sys-config= 参数进行设定。有一些软件还可以加上 –with、–enable、–without、–disable 等等参数对编译加以控制，你可以通过 ./configure –help 查看详细的说明帮助。</p> <h3 id="make"><a href="#make" class="header-anchor">#</a> make</h3> <p>make 表示编译，大多数的源代码包都经过这一步进行编译。如果 在 make 过程中出现 error ，你就要记下错误代码（注意不仅仅是最后一行），然后你可以向开发者提交 bugreport，或者你的系统少了一些依赖库等，这些需要自己仔细研究错误代码。</p> <div class="custom-block tip"><p class="custom-block-title">常见错误</p> <p>make *** 没有指明目标并且找不到 makefile，停止。</p> <p>问题很明显，没有 Makefile，原来是要先 ./configure 一下，再 make。</p></div> <h3 id="make-install"><a href="#make-install" class="header-anchor">#</a> make install</h3> <p>这条命令来进行安装，这一步一般需要你有 root 权限（因为要向系统写入文件）。</p> <h2 id="nodejs-是如何执行的"><a href="#nodejs-是如何执行的" class="header-anchor">#</a> Nodejs 是如何执行的</h2> <p>nodejs 在运行时，会执行以下几行命令：</p> <ul><li>PlatformInit();</li> <li>argv = uv_setup_args(argc,grgv);</li> <li>Init(&amp;argc,const_cast(argv),&amp;exec_argc,&amp;exec_argv)</li> <li>V8::Initialize()</li> <li>Start(uv_default_loop(),argc,argv,exec_argc,exec_argv)</li></ul> <h3 id="platforminit"><a href="#platforminit" class="header-anchor">#</a> PlatformInit</h3> <p>用于对文件进行描述，以及注册两个信号处理函数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">RegisterSignalHander</span><span class="token punctuation">(</span><span class="token constant">SIGINT</span><span class="token punctuation">,</span> SignalExit<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">RegisterSignalHander</span><span class="token punctuation">(</span><span class="token constant">SIGTERM</span><span class="token punctuation">,</span> SignalExit<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h3 id="uv-setup-args"><a href="#uv-setup-args" class="header-anchor">#</a> uv_setup_args</h3> <p>uv_setup_args 是定义在 libuv 中的方法，用于进行 process.title 的设置和读取。</p> <h3 id="init"><a href="#init" class="header-anchor">#</a> Init</h3> <ul><li>初始化 Uptime 值</li> <li>对 node 命令行接收的参数和 V8 的 flag 参数进行映射处理。</li> <li>将 node_is_initialized 标记为 true。</li></ul> <h3 id="v8-initialize"><a href="#v8-initialize" class="header-anchor">#</a> V8::Initialize</h3> <p>所有的 nodejs 源码（js 文件）都会先由 V8 引擎来解释并运行。</p> <h3 id="start-方法"><a href="#start-方法" class="header-anchor">#</a> Start 方法</h3> <p>主要针对于 libuv 进行操作</p> <ul><li>准备工作</li> <li>执行 loadEnvironment(&amp;env)</li> <li>开启 eventloop，无线循环</li> <li>收尾，内存回收，断开 debug 连接。</li></ul> <h3 id="构造-process-对象"><a href="#构造-process-对象" class="header-anchor">#</a> 构造 process 对象</h3> <p>在 loadEnvironment 阶段，会构建 process 对象。</p> <p>process 对象的用法：</p> <ul><li>统计信息，cpu，内存等。
<ul><li>process.cpuUsage();</li></ul></li> <li>事件循环机制，process.nextTick。
<ul><li>nodejs 为事件循环位置了一个队列，nextTick 入队列，_tickCallback 出队列。</li></ul></li> <li>uncaughtException 事件。
<ul><li>全局异常捕获。</li></ul></li> <li>其他
<ul><li>进程管理，exit，kill。</li> <li>i/o 相关，stdout，stderr，stdin。</li> <li>路径处理，cwd，chdir 等。</li></ul></li></ul> <h4 id="绑定内部-c-模块"><a href="#绑定内部-c-模块" class="header-anchor">#</a> 绑定内部 c++模块</h4> <p>process.moduleLoadList 可以查看当前进程已经加载的模块。</p> <ul><li>Binding 模块，通过 process.binding 绑定的内部 c++模块。</li> <li>NativeModule 模块，内部 js 模块。</li></ul> <p>大家常见的.js 文件最后都是通过 process.binding('contextify')进行编译的。</p> <ul><li>var ContextifyScript = process.binding('contextify').ContextifyScript</li> <li>var script = new ContextifyScript(code, option);</li> <li>script.runInThisContext();
<ul><li>内部会调用 EvalMachine 方法，将 js 代码转换成机器码。</li></ul></li></ul> <h3 id="事件循环机制"><a href="#事件循环机制" class="header-anchor">#</a> 事件循环机制</h3> <p>Libuv 实现了 Node.js 中的 Eventloop ，主要有以下几个阶段：</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>   ┌───────────────────────────┐
┌─<span class="token operator">&gt;</span>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle<span class="token punctuation">,</span> prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming<span class="token punctuation">:</span>   │
│  │           poll            │<span class="token operator">&lt;</span>─────┤  connections<span class="token punctuation">,</span> │
│  └─────────────┬─────────────┘      │   data<span class="token punctuation">,</span> etc<span class="token punctuation">.</span>  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>timers：执行 <code>setTimeout</code> 和 <code>setInterval</code> 中到期的 callback。</li> <li>pending callbacks：上一轮循环中有少数的 I/O callback 会被延迟到这一轮的这一阶段执行。</li> <li>idle, prepare：仅内部使用。</li> <li>poll：最为重要的阶段，执行 I/O callback，在适当的条件下会阻塞在这个阶段。</li> <li>check：执行 <code>setImmediate</code> 的 callback。</li> <li>close callbacks：执行 close 事件的 callback，例如 socket.on(&quot;close&quot;,func)。</li></ul> <p><strong>除此之外，Node.js 提供了 process.nextTick 方法，在以上的任意阶段开始执行的时候都会触发。</strong></p> <h4 id="microtask-和-macrotask"><a href="#microtask-和-macrotask" class="header-anchor">#</a> microtask 和 macrotask</h4> <p>在 js 的事件循环机制中，还有两个概念，microtask 微任务 和 macrotask 宏任务。当前调用栈执行完毕时，会分两种情况进行处理。首先处理 microtask 队列里的事件，然后再从 macrotask 队列中取出一个事件并执行。在同义词事件循环中，microtask 永远在 macrotask 之前执行。</p> <ul><li>microtask
<ul><li>process.nextTick</li> <li>promise</li></ul></li> <li>macrotask
<ul><li>setTimeout</li> <li>setInterval</li> <li>setImmediate</li> <li>I/O</li></ul></li></ul> <p>接下来通过一道题来测试一下你对 microtask 和 macrotask 的掌握程度。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'start'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> interval <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setInterval'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 3'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 4'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 5'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 6'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">clearInterval</span><span class="token punctuation">(</span>interval<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'promise 2'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h2 id="buffer"><a href="#buffer" class="header-anchor">#</a> Buffer</h2> <p>为什么要用 buffer？</p> <p>虽然 js 能够很好的处理 unicode 编码的字符串，但对于二进制或非 unicode 编码的数据，处理起来就显得无能为力了。所以 Nodejs 在 sdk 里内置了 buffer 类，可以像其他程序语言一样，处理各种类型的数据。</p> <p>buffer 代表一个缓冲区，用于存储二进制数据，俗称字节流，是 i/o 传输时常用的处理方式。<strong>相比于字符串，buffer 可以免去编码和解码的过程，节省 cpu 成本</strong>，因此在使用 nodejs 进行服务端开发时，http、tcp、udp、io、数据库、处理图片、表文件商户餐等操作，都会用到 buffer。另外 buffer 其实也是 stream 的基础。</p> <p>buffer 的应用场景：</p> <ul><li>在使用 net 或 http 模块接受网络数据时，可用 buffer 作为数据结构进行传输，即 data 事件的参数。</li> <li>用于大文件的读取和写入，以前 fs 读取的内容是 string，后来都改用 buffer，在大文件读取上，性能和内存有明显优势。</li> <li>用于字符转码、进制转换。</li> <li>用作数据结构，处理二进制数据，也可以处理字符编码。</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">let</span> bugger <span class="token operator">=</span> Buffer<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token string">'Hello world!'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//&lt;Buffer 48 65 6c 6c 6f 20 57 6f 72 6c 62 21&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>可以看出，buffer 将字符串中的字符，转换成了对应的十六进制的 ASCII 码。</p> <h3 id="buffer-不得不提的-8kb"><a href="#buffer-不得不提的-8kb" class="header-anchor">#</a> buffer 不得不提的 8KB</h3> <p>buffer 著名的 8KB 载体，举个例子，node 把一幢大房子分成很多小房间，每个房间能容纳 8 个人，为了保证房间的充分使用，只有当一个房间塞满 8 个人后才会去开新的房间，但是当一次性有多个人来入住，node 会保证要把这些人放到一个房间中，比如当前房间 A 有 4 个人住，但是一下子来了 5 个人，所以 node 不得不新开一间房间 B，把这 5 个人安顿下来，此时又来了 4 个人，发现 5 个人的 B 房间也容纳不下了，只能再开一间房间 C 了，这样所有人都安顿下来了。但是之前的两间房 A 和 B 都各自浪费了 4 个和 3 个位置，而房间 C 就成为了当前的房间。</p> <p>具体点说就是当我们实例化一个新的 Buffer 类，会根据实例化时的大小去申请内存空间，如果需要的空间小于 8KB，则会多一次判定，判定当前的 8KB 载体剩余容量是否够新的 buffer 实例，如果够用，则将新的 buffer 实例保存在当前的 8KB 载体中，并且更新剩余的空间。</p> <h2 id="streams"><a href="#streams" class="header-anchor">#</a> Streams</h2> <p>流（stream）是 Node.js 中处理流式数据的抽象接口。</p> <p>Streams 不是 Node.js 独有的概念。它们是几十年前在 Unix 操作系统中引入的。</p> <p>它们能够以一种有效的方式来处理文件的读、写，网络通信或任何类型的端到端信息交换。</p> <p>例如，当你编写了一段程序用来读取文件时，传统的方法是将文件从头到尾读入内存，然后再进行处理。而使用流的话，你就可以逐块读取它，处理其内容而不将其全部保存在内存中。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> rs <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span><span class="token string">'test.md'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> data <span class="token operator">=</span> <span class="token string">''</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  data <span class="token operator">+=</span> chunk<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'end'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>利用 createReadStream 创建一个读取数据的流，来读取 test.md 文件的内容，此时监听 data 事件，它是在当流将数据块传送给消费者后触发。并在对应的 eventHandler 中，拼接 chunk。在 end 事件中，打印到终端上。</p> <p>之前说流，可以逐块读取文件内容，那么这个块，也就是 chunk 是什么？</p> <p>一般情况下是 Buffer，修改 data 事件的 eventHandler 来验证下。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>rs<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'chunk'</span><span class="token punctuation">,</span> Buffer<span class="token punctuation">.</span><span class="token function">isBuffer</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// log true</span>
  data <span class="token operator">+=</span> chunk<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>流的工作方式可以具体的表述为，在内存中准备一段 Buffer，然后在 fs.read() 读取时逐步从磁盘中将字节复制到 Buffer 中。</p> <h3 id="为什么要使用-stream"><a href="#为什么要使用-stream" class="header-anchor">#</a> 为什么要使用 Stream</h3> <p>利用 Stream 来处理数据，主要是因为它的两个优点：</p> <ul><li>内存效率：处理数据之前，不需要占用大量内存。</li> <li>时间效率：处理数据花费的时间更少，因为流是逐块来处理数据，而不是等到整个数据有效负载才启动。</li></ul> <p>首先内存效率，与 fs.readFile 这种会缓冲整个文件相比，流式传输充分地利用 Buffer （超过 8kb）不受 V8 内存控制的特点，利用堆外内存完成高效地传输。</p> <p>时间效率，与 fs.FileSync 相比，有些优势，但是与异步的 fs.readFile 相比，优势不大。</p> <h2 id="nodejs-异步写法与流程控制"><a href="#nodejs-异步写法与流程控制" class="header-anchor">#</a> Nodejs 异步写法与流程控制</h2> <h3 id="基于回调的方式"><a href="#基于回调的方式" class="header-anchor">#</a> 基于回调的方式</h3> <ul><li>nodejs 自带的 api</li></ul> <p>回调函数基于错误优先的返回方式，即回调函数中第一个参数是 err，代表报错信息。</p> <h3 id="基于-eventemitter-的事件处理机制"><a href="#基于-eventemitter-的事件处理机制" class="header-anchor">#</a> 基于 eventEmitter 的事件处理机制</h3> <p>使用观察者模式，代替回调函数，实现数据解耦。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> EventEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'events'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> observer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EventEmitter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 监听事件</span>
observer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'topic'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'topic has changed'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 触发事件</span>
observer<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">'topic'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="基于第三方异步流程库"><a href="#基于第三方异步流程库" class="header-anchor">#</a> 基于第三方异步流程库</h3> <ul><li>async.js 模块</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code>async<span class="token punctuation">.</span><span class="token function">series</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'one'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">cb</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">'two'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><ul><li>thunk 函数封装。</li> <li>使用 Thunkify 模块自动封装。</li></ul> <p>thunk 函数的作用是将多参数替换成单参数。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">Thunk</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token operator">...</span>args<span class="token punctuation">,</span> callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 手动封装</span>
<span class="token keyword">var</span> readfileThunk <span class="token operator">=</span> <span class="token function">Thunk</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 自动封装</span>
<span class="token keyword">var</span> readfileThunk <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'thunkify'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>fs<span class="token punctuation">.</span>readFile<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">readfileThunk</span><span class="token punctuation">(</span><span class="token string">'./xxx.js'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="基于-promise-异步处理"><a href="#基于-promise-异步处理" class="header-anchor">#</a> 基于 promise 异步处理</h3> <p>推荐两个社区比较有名的库：</p> <ul><li>q</li> <li>bluebird</li></ul> <p>其中 bluebird 性能比较好，使用也很简洁，兼容源生 promise。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>Global<span class="token punctuation">.</span>Promise <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'bluebird'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">var</span> xxx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="基于-generator"><a href="#基于-generator" class="header-anchor">#</a> 基于 generator</h3> <p>generator 是一个生成器，会根据 yield 一步一步地生成数据。co 是 generator 的执行器，会自动执行完所有的 yield，他们可以配合使用，达到类似于同步的方式。</p> <ul><li>co + generator</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token function">co</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">yield</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'value:'</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'err:'</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="终极解决办法"><a href="#终极解决办法" class="header-anchor">#</a> 终极解决办法</h3> <p>随着 es 规范的不断发展，async+await 成为了编写异步的最简单的方式。</p> <ul><li>async + await</li></ul> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'./xxx.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>总的来说，这本书讲的很基础，从宏观的角度介绍了 nodejs，对 node 运行流程这一章也有很深入的理解。由于 nodejs 的 api 都是基于回调式的，为了解决回调嵌套的问题，可以使用终极解决方案，async await。</p> <h2 id="参考链接"><a href="#参考链接" class="header-anchor">#</a> 参考链接</h2> <ul><li><a href="https://cnodejs.org/topic/5189ff4f63e9f8a54207f60c" target="_blank" rel="noopener noreferrer">浅析 nodejs 的 buffer 类<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://www.zhangshengrong.com/p/YjNKn8oxaW/" target="_blank" rel="noopener noreferrer">深入浅出了解 Node.js Streams<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">11/8/2019, 4:51:43 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.4d237ac1.js" defer></script><script src="/assets/js/2.a060ff2c.js" defer></script><script src="/assets/js/124.c4050122.js" defer></script>
  </body>
</html>
